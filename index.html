<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Sheet Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .app-container { max-width: 960px; margin: 1rem auto; }
        .step-section { transition: all 0.3s ease; border: 1px solid #e2e8f0; }
        .step-header { font-weight: 700; font-size: 1.5rem; color: #1e293b; margin-bottom: 1rem; }
        input[type="file"] { display: none; }
        .custom-file-upload { display: inline-block; cursor: pointer; padding: 14px 28px; border-radius: 50px; background-color: #4f46e5; color: #ffffff; font-weight: 600; transition: background-color 0.3s ease; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .custom-file-upload:hover { background-color: #4338ca; }
        .action-button { padding: 12px 24px; border-radius: 50px; font-weight: 600; transition: all 0.2s ease; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .action-button:hover { transform: translateY(-2px); }
        .action-button:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none; }
        .next-button { background-color: #10b981; color: #ffffff; }
        .next-button:hover:not(:disabled) { background-color: #059669; }
        .input-group input, .input-group select { padding: 12px; border-radius: 10px; border: 1px solid #cbd5e1; width: 100%; transition: border-color 0.3s ease, box-shadow 0.3s ease; background-color: white; }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); }
        .input-group input.input-error, .input-group select.input-error {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }
        .status-box { padding: 12px; border-radius: 10px; font-weight: 500; margin-top: 1rem; }
        .status-success { background-color: #dcfce7; color: #16a34a; }
        .status-error { background-color: #fee2e2; color: #ef4444; }
        .status-warn { background-color: #fef9c3; color: #ca8a04; }
        .summary-box { border: 2px solid #6366f1; background-color: #eef2ff; padding: 1rem; border-radius: 12px; font-weight: 600; color: #4338ca; }
        .remove-block-btn { background-color: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 16px; cursor: pointer; line-height: 1; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s ease; }
        .remove-block-btn:hover { background-color: #dc2626; }
        .stepper { display: flex; justify-content: space-between; margin-bottom: 2rem; position: relative; }
        .step { text-align: center; flex: 1; }
        .step-circle { width: 40px; height: 40px; border-radius: 50%; background-color: #e2e8f0; color: #64748b; display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem; font-weight: 600; transition: all 0.3s ease; border: 2px solid transparent; }
        .step-label { font-size: 0.875rem; color: #64748b; font-weight: 500; }
        .step.active .step-circle { background-color: #4f46e5; color: white; border-color: #a5b4fc; }
        .step.active .step-label { color: #1e293b; }
        .stepper::before { content: ''; position: absolute; top: 20px; left: 10%; right: 10%; height: 2px; background-color: #e2e8f0; transform: translateY(-50%); z-index: -1; }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(15, 23, 42, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
    </style>
</head>
<body class="p-2 sm:p-4">
    <div class="app-container bg-white p-4 sm:p-8 rounded-2xl shadow-lg">
        <img id="site-banner" src="site_banner.png" alt="Exam Banner" class="w-full h-auto rounded-lg mb-8 shadow-md" onerror="this.style.display='none'">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-center mb-8 text-slate-800">Attendance Sheet Creator</h1>

        <!-- Stepper UI -->
        <div class="stepper mb-10">
            <div id="stepper-1" class="step"><div class="step-circle">1</div><div class="step-label">Upload Data</div></div>
            <div id="stepper-2" class="step"><div class="step-circle">2</div><div class="step-label">Define Blocks</div></div>
            <div id="stepper-3" class="step"><div class="step-circle">3</div><div class="step-label">Exam Details</div></div>
        </div>

        <!-- Step 1: Upload File -->
        <div id="step-1" class="step-section p-4 sm:p-6 rounded-lg">
            <div class="step-header">Step 1: Upload Student Data</div>
            <p class="text-slate-600 mb-6">Upload your student list to begin. The university logo will be added automatically to the PDF.</p>
            
            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                <label for="student-file" class="custom-file-upload w-full sm:w-auto text-center">Choose Student File</label>
                <input type="file" id="student-file" accept=".csv, .xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                <span id="file-name" class="text-slate-500 truncate">No file selected.</span>
            </div>
            <div class="mt-4 flex items-center">
                <input type="checkbox" id="headerless-file" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="headerless-file" class="ml-2 block text-sm text-slate-800 font-medium">My file does not have a header row</label>
            </div>

            <hr class="my-6">

            <div>
                <h3 class="font-semibold text-slate-700 mb-2">Required Excel Format</h3>
                <p class="text-slate-600 text-sm mb-4">Your file should have columns for enrollment number and student name. The column names don't matter, as you can map them in the next step.</p>
                <img src="excel_preview.png" alt="Example of correct excel format" class="rounded-md border border-slate-300 shadow-sm" onerror="this.style.display='none'; this.parentElement.querySelector('p').textContent = 'Preview image (excel_preview.png) not found in repository.'">
            </div>

            <div id="file-status" class="status-box hidden"></div>
            
            <!-- Data Preview Section -->
            <div id="data-preview-section" class="hidden mt-6">
                <h3 class="text-lg font-semibold text-slate-700 mb-2">Data Preview</h3>
                <div class="overflow-x-auto rounded-lg border border-slate-200">
                    <table id="preview-table" class="min-w-full divide-y divide-slate-200 text-sm">
                        <thead class="bg-slate-50"></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="flex justify-end mt-6">
                 <button id="next-to-step2-btn" class="action-button next-button w-full sm:w-auto" disabled>Next â†’</button>
            </div>
        </div>

        <!-- Step 2: Define Blocks -->
        <div id="step-2" class="step-section mt-8 hidden p-4 sm:p-6 rounded-lg">
            <div class="step-header">Step 2: Define Exam Blocks</div>
            <p class="text-slate-600 mb-6">Allocate students into blocks. You can create one special block for a specific enrollment range, and then allocate the rest by count.</p>

            <!-- Toggle for Optional Range Block Section -->
            <div id="show-range-block-container" class="mb-6 text-center border border-dashed border-gray-300 p-4 rounded-lg hover:border-indigo-400 transition-colors cursor-pointer">
                <button id="show-range-block-btn" class="text-indigo-600 font-semibold w-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Create a Block by Enrollment Range (Optional)
                </button>
            </div>

            <!-- Optional Range Block Section (Hidden by default) -->
            <div id="range-block-section" class="hidden mb-8 p-4 border border-dashed border-indigo-300 rounded-lg bg-indigo-50">
                <h3 class="font-semibold text-lg text-indigo-800 mb-3">Optional: Create a Block by Enrollment Range</h3>
                <div id="range-block-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="input-group md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Start Enrollment No.</label><input type="text" id="start-enrollment" placeholder="e.g., 24C24510"></div>
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">End Enrollment No.</label><input type="text" id="end-enrollment" placeholder="e.g., 24C24530"></div>
                    </div>
                     <div class="input-group"><label class="block text-sm font-medium text-slate-700 mb-1">Exam Centre</label><select id="range-block-center"><option value="">Select Center</option><option value="SOB">SOB</option><option value="SOP">SOP</option><option value="SOCSET" selected>SOCSET</option></select></div>
                     <div class="input-group"><label class="block text-sm font-medium text-slate-700 mb-1">Room No.</label><input type="text" id="range-block-room-no" placeholder="e.g., EB 54"></div>
                     <div class="input-group"><label class="block text-sm font-medium text-slate-700 mb-1">Block No.</label><input type="text" id="range-block-no" placeholder="e.g., 5"></div>
                     <div class="md:col-span-2 flex justify-end items-center"><button id="create-range-block-btn" class="action-button bg-indigo-600 text-white hover:bg-indigo-700">Create Special Block</button></div>
                </div>
                 <div id="range-block-status" class="status-box hidden"></div>
            </div>
            
            <div class="summary-box mb-6 text-sm sm:text-base">
                Total Students: <span id="total-students-original">0</span> | 
                Students to Allocate: <span id="total-students-to-allocate">0</span>
            </div>

            <hr class="my-6">
            <h3 class="font-semibold text-lg text-slate-800 mb-3">Allocate Remaining Students by Count</h3>
            <div id="blocks-container"></div>
            <div class="flex items-center justify-between mt-6">
                <button id="add-block" class="action-button bg-gray-200 text-slate-700 hover:bg-gray-300 text-sm sm:text-base">+ Add Block</button>
                <div id="student-count-status" class="status-box hidden p-2 text-sm mt-0"></div>
            </div>
            <div class="flex justify-end mt-8">
                <button id="next-to-step3-btn" class="action-button next-button w-full sm:w-auto" disabled>Next â†’</button>
            </div>
        </div>

        <!-- Step 3: Enter Exam Details -->
        <div id="step-3" class="step-section mt-8 hidden p-4 sm:p-6 rounded-lg">
            <div class="step-header">Step 3: Enter Exam Details</div>
            <p class="text-slate-600 mb-6">Provide the general details that will appear on every sheet.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="input-group">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Branch</label>
                    <select id="branch">
                        <option value="">Select Branch</option>
                        <option value="BTECH">BTECH</option>
                        <option value="DIPLOMA">DIPLOMA</option>
                        <option value="BCA">BCA</option>
                        <option value="MCA">MCA</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Semester</label>
                    <select id="semester">
                        <option value="">Select Semester</option>
                        <option value="Semester - 1">Semester - 1</option>
                        <option value="Semester - 2">Semester - 2</option>
                        <option value="Semester - 3">Semester - 3</option>
                        <option value="Semester - 4">Semester - 4</option>
                        <option value="Semester - 5">Semester - 5</option>
                        <option value="Semester - 6">Semester - 6</option>
                        <option value="Semester - 7">Semester - 7</option>
                        <option value="Semester - 8">Semester - 8</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Academic Year</label>
                    <select id="academic-year"></select>
                </div>
                <div class="input-group"><label class="block text-sm font-medium text-slate-700 mb-1">Course Code</label><input type="text" id="course-code" placeholder="e.g., C4361C1"></div>
                <div class="input-group"><label class="block text-sm font-medium text-slate-700 mb-1">Course Name</label><input type="text" id="course-name" placeholder="e.g., Data Structures"></div>
                <div class="input-group">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Specialization</label>
                     <select id="specialization">
                        <option value="">Select Specialization</option>
                        <option value="CSE">CSE</option>
                        <option value="IT">IT</option>
                        <option value="AI">AI</option>
                        <option value="DS">DS</option>
                        <option value="CS">CS</option>
                        <option value="CSA">CSA</option>
                    </select>
                </div>
                <div class="input-group"><label class="block text-sm font-medium text-slate-700 mb-1">Date</label><input type="text" id="exam-date" placeholder="Select Date..."></div>
                <div class="input-group"><label class="block text-sm font-medium text-slate-700 mb-1">Time</label><input type="text" id="exam-time" placeholder="Select Time..."></div>
                <div class="md:col-span-2 flex items-center mt-2">
                    <input type="checkbox" id="is-remedial-exam" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="is-remedial-exam" class="ml-2 block text-sm text-slate-800 font-medium">Is this a Remedial Exam?</label>
                </div>
            </div>
            
            <div class="flex items-center justify-end mt-6">
                <input type="checkbox" id="combine-pdf" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                <label for="combine-pdf" class="ml-2 block text-sm text-slate-800 font-medium">Combine all sheets into a single PDF file</label>
            </div>

            <div class="flex flex-col-reverse sm:flex-row justify-between mt-8 gap-4">
                 <button id="reset-btn" class="action-button bg-gray-200 text-slate-700 hover:bg-gray-300 w-full sm:w-auto">Start Over</button>
                <button id="generate-btn" class="action-button next-button w-full sm:w-auto">Generate PDF(s)</button>
            </div>
        </div>

        <footer class="text-center mt-10 text-xs text-slate-500">
            <p>Created by Neel Patel</p>
        </footer>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-60 items-center justify-center hidden z-50">
        <div class="text-white text-center">
            <svg class="animate-spin h-10 w-10 text-white mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg font-semibold">Generating your PDF(s)...</p>
            <p>Please wait a moment.</p>
        </div>
    </div>

    <!-- Column Mapping Modal -->
    <div id="mapping-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold text-slate-800 mb-4">Map Your Data Columns</h2>
            <p class="text-slate-600 mb-6">Please tell us which columns in your file correspond to the required fields.</p>
            <div class="space-y-4">
                <div class="input-group">
                    <label for="enrollment-map" class="block text-sm font-medium text-slate-700 mb-1">Enrollment Number Column</label>
                    <select id="enrollment-map"></select>
                </div>
                 <div class="input-group">
                    <label for="name-map" class="block text-sm font-medium text-slate-700 mb-1">Student Name Column</label>
                    <select id="name-map"></select>
                </div>
            </div>
            <div class="flex justify-end mt-8">
                <button id="confirm-mapping-btn" class="action-button next-button">Confirm & Preview</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { jsPDF } = window.jspdf;

            // Global state
            const state = {
                studentData: [],
                totalStudentsInFile: 0,
                studentsToAllocateCount: 0,
                enrollmentNoKey: null,
                studentNameKey: null,
                blockCount: 0,
                rawHeaders: [],
                tempJsonData: [],
                logoBase64: null,
            };

            // DOM elements
            const ui = {
                studentFile: document.getElementById('student-file'),
                fileNameSpan: document.getElementById('file-name'),
                fileStatus: document.getElementById('file-status'),
                headerlessCheckbox: document.getElementById('headerless-file'),
                nextToStep2Btn: document.getElementById('next-to-step2-btn'),
                nextToStep3Btn: document.getElementById('next-to-step3-btn'),
                generateBtn: document.getElementById('generate-btn'),
                addBlockBtn: document.getElementById('add-block'),
                blocksContainer: document.getElementById('blocks-container'),
                studentCountStatus: document.getElementById('student-count-status'),
                totalStudentsOriginal: document.getElementById('total-students-original'),
                totalStudentsToAllocate: document.getElementById('total-students-to-allocate'),
                resetBtn: document.getElementById('reset-btn'),
                loadingOverlay: document.getElementById('loading-overlay'),
                combinePdfCheckbox: document.getElementById('combine-pdf'),
                mappingModal: document.getElementById('mapping-modal'),
                enrollmentMap: document.getElementById('enrollment-map'),
                nameMap: document.getElementById('name-map'),
                confirmMappingBtn: document.getElementById('confirm-mapping-btn'),
                dataPreviewSection: document.getElementById('data-preview-section'),
                previewTable: document.getElementById('preview-table'),
                showRangeBlockContainer: document.getElementById('show-range-block-container'),
                showRangeBlockBtn: document.getElementById('show-range-block-btn'),
                rangeBlock: {
                    section: document.getElementById('range-block-section'),
                    form: document.getElementById('range-block-form'),
                    startEnrollment: document.getElementById('start-enrollment'),
                    endEnrollment: document.getElementById('end-enrollment'),
                    center: document.getElementById('range-block-center'),
                    roomNo: document.getElementById('range-block-room-no'),
                    blockNo: document.getElementById('range-block-no'),
                    createBtn: document.getElementById('create-range-block-btn'),
                    status: document.getElementById('range-block-status'),
                },
                examDetails: {
                    branch: document.getElementById('branch'),
                    semester: document.getElementById('semester'),
                    academicYear: document.getElementById('academic-year'),
                    courseCode: document.getElementById('course-code'),
                    courseName: document.getElementById('course-name'),
                    specialization: document.getElementById('specialization'),
                    examDate: document.getElementById('exam-date'),
                    examTime: document.getElementById('exam-time'),
                    isRemedialExam: document.getElementById('is-remedial-exam'),
                }
            };

            // Event listeners
            ui.studentFile.addEventListener('change', handleFile);
            ui.nextToStep2Btn.addEventListener('click', () => navigateToStep(2));
            ui.addBlockBtn.addEventListener('click', () => addBlockInput());
            ui.blocksContainer.addEventListener('input', updateStudentCountStatus);
            ui.nextToStep3Btn.addEventListener('click', () => navigateToStep(3));
            ui.generateBtn.addEventListener('click', generateSheets);
            ui.resetBtn.addEventListener('click', resetApp);
            ui.confirmMappingBtn.addEventListener('click', processMappedData);
            ui.rangeBlock.createBtn.addEventListener('click', createSpecialBlock);
            ui.showRangeBlockBtn.addEventListener('click', showRangeBlockSection);
            
            // --- Navigation ---
            function navigateToStep(stepNumber) {
                document.querySelectorAll('.step-section').forEach(sec => sec.classList.add('hidden'));
                document.getElementById(`step-${stepNumber}`).classList.remove('hidden');

                document.querySelectorAll('.stepper .step').forEach((step, index) => {
                    step.classList.remove('active');
                    if (index < stepNumber) {
                        step.classList.add('active');
                    }
                });

                if (stepNumber === 2) {
                    ui.totalStudentsOriginal.textContent = state.totalStudentsInFile;
                    state.studentsToAllocateCount = state.studentData.filter(s => !s.isAllocated).length;
                    ui.totalStudentsToAllocate.textContent = state.studentsToAllocateCount;
                }
            }

            // --- Dynamic Year Population ---
            function populateAcademicYears() {
                const yearSelect = ui.examDetails.academicYear;
                yearSelect.innerHTML = '<option value="">Select Academic Year</option>';
                const currentYear = new Date().getFullYear();
                for (let i = -1; i < 4; i++) { // Show previous year as well
                    const startYear = currentYear + i;
                    const endYear = (startYear + 1).toString().slice(-2);
                    const yearString = `${startYear}-${endYear}`;
                    const option = document.createElement('option');
                    option.value = yearString;
                    option.textContent = yearString;
                    if(i === 0) option.selected = true;
                    yearSelect.appendChild(option);
                }
            }


            // --- Step 1: File Handling & Mapping ---
            function handleFile(event) {
                const file = event.target.files[0];
                if (!file) {
                    ui.fileNameSpan.textContent = 'No file selected.';
                    return;
                }
                ui.fileNameSpan.textContent = file.name;
                ui.dataPreviewSection.classList.add('hidden'); // Hide old preview

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        if (ui.headerlessCheckbox.checked) {
                            const aoa = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                            if (aoa.length === 0) {
                                showStatus(ui.fileStatus, 'The file is empty.', 'error');
                                return;
                            }
                            state.rawHeaders = aoa[0].map((_, i) => `Column ${String.fromCharCode(65 + i)}`);
                            state.tempJsonData = aoa.map(row => {
                                const obj = {};
                                state.rawHeaders.forEach((h, i) => {
                                    obj[h] = row[i];
                                });
                                return obj;
                            });
                        } else {
                            state.tempJsonData = XLSX.utils.sheet_to_json(sheet);
                            if (state.tempJsonData.length === 0) {
                                showStatus(ui.fileStatus, 'The file is empty or has no data.', 'error');
                                return;
                            }
                            state.rawHeaders = Object.keys(state.tempJsonData[0]);
                        }
                        
                        openMappingModal();

                    } catch (error) {
                        showStatus(ui.fileStatus, `Error reading file: ${error.message}.`, 'error');
                        console.error("File processing error:", error);
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            function openMappingModal() {
                ui.enrollmentMap.innerHTML = '';
                ui.nameMap.innerHTML = '';
                
                state.rawHeaders.forEach(header => {
                    const option = new Option(header, header);
                    ui.enrollmentMap.add(option.cloneNode(true));
                    ui.nameMap.add(option.cloneNode(true));
                });
                
                const autoEnrollment = findHeader(state.rawHeaders, ['enrollment no', 'enrollment', 'roll no', 'roll', 'enr no', 'column a']);
                const autoName = findHeader(state.rawHeaders, ['student name', 'name of student', 'name', 'full name', 'column b']);
                if (autoEnrollment) ui.enrollmentMap.value = autoEnrollment;
                if (autoName) ui.nameMap.value = autoName;

                ui.mappingModal.classList.remove('hidden');
            }
            
            function processMappedData() {
                state.enrollmentNoKey = ui.enrollmentMap.value;
                state.studentNameKey = ui.nameMap.value;
                
                if (state.enrollmentNoKey === state.studentNameKey) {
                    showStatus(ui.fileStatus, 'Enrollment and Name columns cannot be the same.', 'error');
                    return;
                }

                state.studentData = state.tempJsonData.map(row => ({ ...row, isAllocated: false }));
                state.totalStudentsInFile = state.studentData.length;
                showStatus(ui.fileStatus, `Successfully mapped and loaded ${state.totalStudentsInFile} students.`, 'success');
                ui.nextToStep2Btn.disabled = false;
                ui.mappingModal.classList.add('hidden');
                
                displayDataPreview();
            }

            function displayDataPreview() {
                ui.dataPreviewSection.classList.remove('hidden');
                const thead = ui.previewTable.querySelector('thead');
                const tbody = ui.previewTable.querySelector('tbody');
                
                thead.innerHTML = `
                    <tr class="text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                        <th class="px-4 py-2">${state.enrollmentNoKey}</th>
                        <th class="px-4 py-2">${state.studentNameKey}</th>
                    </tr>`;
                
                tbody.innerHTML = '';
                const previewData = state.studentData.slice(0, 5);
                previewData.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = 'bg-white divide-y divide-slate-200';
                    tr.innerHTML = `
                        <td class="px-4 py-2 whitespace-nowrap text-slate-700">${row[state.enrollmentNoKey] || ''}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-slate-700">${row[state.studentNameKey] || ''}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            function findHeader(headers, possibleNames) {
                 for (const name of possibleNames) {
                    const found = headers.find(h => h.toLowerCase().trim().includes(name));
                    if (found) return found;
                }
                return null;
            }

            // --- Step 2: Block Management ---
            function showRangeBlockSection() {
                ui.rangeBlock.section.classList.remove('hidden');
                ui.showRangeBlockContainer.classList.add('hidden');
            }

            function createSpecialBlock() {
                const start = ui.rangeBlock.startEnrollment.value.trim().toUpperCase();
                const end = ui.rangeBlock.endEnrollment.value.trim().toUpperCase();

                if (!start || !end) {
                    showStatus(ui.rangeBlock.status, 'Please provide both a start and end enrollment number.', 'error');
                    return;
                }

                const studentsInRange = state.studentData.filter(student => {
                    const enrNo = String(student[state.enrollmentNoKey]).toUpperCase();
                    return !student.isAllocated && enrNo >= start && enrNo <= end;
                });

                if (studentsInRange.length === 0) {
                     showStatus(ui.rangeBlock.status, 'No unallocated students found in the specified enrollment range.', 'warn');
                     return;
                }

                ui.blocksContainer.innerHTML = '';

                state.studentData.forEach(s => s.isAllocated = false);
                studentsInRange.forEach(s => s.isAllocated = true);
                
                const blockDetails = {
                    center: ui.rangeBlock.center.value,
                    roomNo: ui.rangeBlock.roomNo.value,
                    blockNo: ui.rangeBlock.blockNo.value,
                    count: studentsInRange.length
                };
                
                addBlockInput(true, blockDetails);

                navigateToStep(3);
            }


            function addBlockInput(isSpecial = false, details = {}) {
                state.blockCount++;
                const blockDiv = document.createElement('div');
                blockDiv.className = 'block-item flex flex-col gap-4 mb-4 p-4 rounded-lg bg-slate-50 border border-slate-200';
                
                let blockHTML = `
                    <div class="flex items-center justify-between">
                        <div class="font-bold text-lg text-slate-700">${isSpecial ? 'Special Block' : `Block ${state.blockCount}`}</div>
                        ${!isSpecial ? `<button class="remove-block-btn" onclick="this.closest('.block-item').remove(); updateStudentCountStatus();">&times;</button>` : ''}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                `;

                if (isSpecial) {
                    blockHTML += `
                        <div class="input-group"><label class="block text-sm font-medium text-slate-700 mb-1">Exam Centre</label><input type="text" class="block-center" value="${details.center}" readonly></div>
                        <div class="input-group"><label class="block text-sm font-medium text-slate-700 mb-1">Room No.</label><input type="text" class="block-room-no" value="${details.roomNo}" readonly></div>
                        <div class="input-group"><label class="block text-sm font-medium text-slate-700 mb-1">Block No.</label><input type="text" class="block-no" value="${details.blockNo}" readonly></div>
                        <div class="input-group"><label class="block text-sm font-medium text-slate-700 mb-1">No. of Students</label><input type="number" class="block-students" value="${details.count}" readonly></div>
                    `;
                } else {
                     blockHTML += `
                        <div class="input-group"><label class="block text-sm font-medium text-slate-700 mb-1">Exam Centre</label><select class="block-center" required><option value="">Select Center</option><option value="SOB">SOB</option><option value="SOP">SOP</option><option value="SOCSET" selected>SOCSET</option></select></div>
                        <div class="input-group"><label class="block text-sm font-medium text-slate-700 mb-1">Room No.</label><input type="text" class="block-room-no" placeholder="e.g., EB 54" required></div>
                        <div class="input-group"><label class="block text-sm font-medium text-slate-700 mb-1">Block No.</label><input type="text" class="block-no" placeholder="e.g., 5" required></div>
                        <div class="input-group"><label class="block text-sm font-medium text-slate-700 mb-1">No. of Students</label><input type="number" class="block-students" placeholder="Number of students" required min="1"></div>
                     `;
                }
                blockHTML += `</div>`;
                blockDiv.innerHTML = blockHTML;
                ui.blocksContainer.appendChild(blockDiv);
                updateStudentCountStatus();
            }

            function updateStudentCountStatus() {
                window.updateStudentCountStatus = updateStudentCountStatus;
                
                state.studentsToAllocateCount = state.studentData.filter(s => !s.isAllocated).length;
                ui.totalStudentsToAllocate.textContent = state.studentsToAllocateCount;
                
                const regularInputs = Array.from(ui.blocksContainer.querySelectorAll('.block-students:not([readonly])'));
                let totalInRegularBlocks = regularInputs.reduce((sum, input) => sum + (parseInt(input.value) || 0), 0);
                
                ui.studentCountStatus.classList.remove('hidden', 'status-success', 'status-warn', 'status-error');
                ui.nextToStep3Btn.disabled = true;

                if (totalInRegularBlocks > state.studentsToAllocateCount) {
                    ui.studentCountStatus.className = 'status-box status-error p-2 text-sm mt-0';
                    ui.studentCountStatus.textContent = `Allocated: ${totalInRegularBlocks} (Exceeds remaining ${state.studentsToAllocateCount}!)`;
                } else if (totalInRegularBlocks === state.studentsToAllocateCount) {
                    ui.studentCountStatus.className = 'status-box status-success p-2 text-sm mt-0';
                    ui.studentCountStatus.textContent = `Allocated: ${totalInRegularBlocks} (Perfect!)`;
                    if (state.studentsToAllocateCount > 0 || ui.blocksContainer.querySelector('.block-students[readonly]')) {
                         ui.nextToStep3Btn.disabled = false;
                    }
                } else {
                    ui.studentCountStatus.className = 'status-box status-warn p-2 text-sm mt-0';
                    ui.studentCountStatus.textContent = `Allocated: ${totalInRegularBlocks} (Remaining: ${state.studentsToAllocateCount - totalInRegularBlocks})`;
                }

                if (totalInRegularBlocks === 0 && ui.blocksContainer.children.length === 0) {
                     ui.studentCountStatus.classList.add('hidden');
                }
                if (state.studentsToAllocateCount === 0 && ui.blocksContainer.querySelector('.block-students[readonly]')) {
                    ui.nextToStep3Btn.disabled = false;
                    ui.studentCountStatus.classList.add('hidden');
                }

            }
            
            // --- Step 3 & Final Generation ---
            async function generateSheets() {
                Object.values(ui.examDetails).forEach(el => el.classList.remove('input-error'));

                const generalDetails = {
                    branch: ui.examDetails.branch.value,
                    semester: ui.examDetails.semester.value,
                    academicYear: ui.examDetails.academicYear.value,
                    courseCode: ui.examDetails.courseCode.value,
                    courseName: ui.examDetails.courseName.value,
                    specialization: ui.examDetails.specialization.value,
                    examDate: ui.examDetails.examDate.value,
                    examTime: ui.examDetails.examTime.value,
                    isRemedial: ui.examDetails.isRemedialExam.checked,
                };
                
                let allDetailsFilled = true;
                Object.keys(generalDetails).forEach(key => {
                    if (typeof generalDetails[key] === 'string' && generalDetails[key].trim() === '') {
                        allDetailsFilled = false;
                        ui.examDetails[key]?.classList.add('input-error');
                    }
                });

                if (!allDetailsFilled) {
                    showStatus(ui.fileStatus, 'Please fill in all highlighted fields before generating.', 'error');
                    navigateToStep(3);
                    return;
                }

                ui.loadingOverlay.classList.remove('hidden');
                ui.loadingOverlay.classList.add('flex');
                
                try {
                    const blockElements = ui.blocksContainer.querySelectorAll('.block-item');
                    let studentIndexForRegularBlocks = state.studentData.findIndex(s => !s.isAllocated);
                    if (studentIndexForRegularBlocks === -1) studentIndexForRegularBlocks = state.studentData.length;

                    const allBlockStudents = [];
                    blockElements.forEach(block => {
                        const studentCountInput = block.querySelector('.block-students');
                        const count = parseInt(studentCountInput.value);

                        if (studentCountInput.hasAttribute('readonly')) {
                            allBlockStudents.push({
                                students: state.studentData.filter(s => s.isAllocated),
                                details: getBlockDetails(block, count, generalDetails)
                            });
                        } else {
                            const students = state.studentData.slice(studentIndexForRegularBlocks, studentIndexForRegularBlocks + count);
                            studentIndexForRegularBlocks += count;
                            allBlockStudents.push({
                                students: students,
                                details: getBlockDetails(block, count, generalDetails)
                            });
                        }
                    });

                    const isCombineChecked = ui.combinePdfCheckbox.checked;

                    if (isCombineChecked) {
                        const doc = new jsPDF('p', 'mm', 'a4');
                        for (let i = 0; i < allBlockStudents.length; i++) {
                            await drawPageOnDoc(doc, allBlockStudents[i].students, allBlockStudents[i].details);
                            if (i < allBlockStudents.length - 1) {
                                doc.addPage();
                            }
                        }
                        doc.save('Combined_Attendance_Sheets.pdf');
                    } else {
                         for (const blockData of allBlockStudents) {
                            const doc = new jsPDF('p', 'mm', 'a4');
                            await drawPageOnDoc(doc, blockData.students, blockData.details);
                            doc.save(`Attendance_Sheet_Block_${blockData.details.blockNo}.pdf`);
                        }
                    }
                    showStatus(ui.fileStatus, 'Your PDF(s) have been generated successfully!', 'success');
                } catch (error) {
                    console.error("PDF Generation Error:", error);
                    showStatus(ui.fileStatus, `An error occurred during PDF generation: ${error.message}`, 'error');
                } finally {
                    ui.loadingOverlay.classList.add('hidden');
                    ui.loadingOverlay.classList.remove('flex');
                }
            }

            function getBlockDetails(blockElement, studentCount, generalDetails) {
                 return {
                    ...generalDetails,
                    center: blockElement.querySelector('.block-center').value,
                    roomNo: blockElement.querySelector('.block-room-no').value,
                    blockNo: blockElement.querySelector('.block-no').value,
                    totalStudentsInBlock: studentCount
                };
            }

            async function drawPageOnDoc(doc, students, examDetails) {
                const pageWidth = doc.internal.pageSize.getWidth();
                let startY;
                let headerEndY = 10;
                
                const addLogoPromise = new Promise((resolve) => {
                    if (state.logoBase64) {
                        const img = new Image();
                        img.onload = function() {
                            const imgWidth = 30;
                            const imgHeight = (this.height / this.width) * imgWidth;
                            if(imgHeight > 0 && imgWidth > 0){
                                doc.addImage(state.logoBase64, 'PNG', 15, 10, imgWidth, imgHeight);
                                headerEndY = 10 + imgHeight;
                            } else {
                                const universityName = "ITM SLS BARODA UNIVERSITY";
                                doc.setFont("helvetica", "bold").setFontSize(10).text(universityName, 15, 15);
                                headerEndY = 20;
                            }
                            resolve();
                        };
                        img.onerror = function() {
                            const universityName = "ITM SLS BARODA UNIVERSITY";
                            doc.setFont("helvetica", "bold").setFontSize(10).text(universityName, 15, 15);
                            headerEndY = 20;
                            resolve();
                        };
                        img.src = state.logoBase64;
                    } else {
                        const universityName = "ITM SLS BARODA UNIVERSITY";
                        doc.setFont("helvetica", "bold").setFontSize(10).text(universityName, 15, 15);
                        headerEndY = 20;
                        resolve();
                    }
                });

                await addLogoPromise;
                
                doc.setFont("helvetica", "normal").setFontSize(10);
                doc.text("Attendance Sheet", pageWidth - 15, 15, { align: "right" });
                
                let courseDetailsString = examDetails.branch;
                if (examDetails.isRemedial) {
                    courseDetailsString += ' Remedial';
                }
                if (examDetails.specialization) {
                    courseDetailsString += ` ${examDetails.specialization}`;
                }
                courseDetailsString += ` ${examDetails.semester} - ${examDetails.academicYear}`;
                
                doc.text(courseDetailsString, pageWidth - 15, 20, { align: "right" });
                headerEndY = Math.max(headerEndY, 25);
                
                // Draw the divider line
                const lineY = headerEndY + 2;
                doc.setDrawColor(0, 0, 0); // Black color
                doc.setLineWidth(0.2);
                doc.line(15, lineY, pageWidth - 15, lineY); // fromX, fromY, toX, toY
                
                startY = lineY + 3;

                const startEnrollment = students.length > 0 ? (students[0][state.enrollmentNoKey] || '') : '';
                const endEnrollment = students.length > 0 ? (students[students.length - 1][state.enrollmentNoKey] || '') : '';
                const enrollmentRange = `ENROLLMENT NO: FROM ${startEnrollment} TO ${endEnrollment}`;

                doc.autoTable({
                    startY: startY,
                    theme: 'grid',
                    styles: { fontSize: 9, cellPadding: 1.5, lineWidth: 0.1, lineColor: [0, 0, 0], valign: 'middle', textColor: [0, 0, 0] },
                    headStyles: { lineColor: [0, 0, 0] },
                    body: [
                        [{ content: `CENTRE: SOCSET` }, { content: `BLOCK NO: ${examDetails.blockNo}` }, { content: `DATE: ${examDetails.examDate} | TIME: ${examDetails.examTime}`, styles: { halign: 'left' } }],
                        [{ content: `EXAM CENTRE: ${examDetails.center}` }, { content: `COURSE: ${examDetails.courseCode} - ${examDetails.courseName}`, colSpan: 2, styles: { cellWidth: 'wrap' } }],
                        [{ content: `ROOM NO.: ${examDetails.roomNo}` }, { content: enrollmentRange, colSpan: 2 }]
                    ],
                    columnStyles: { 0: { cellWidth: 45 }, 1: { cellWidth: 45 }, 2: { cellWidth: 'auto' } },
                });
                
                const studentTableData = students.map((student, index) => [
                    (index + 1), student[state.enrollmentNoKey] || '', student[state.studentNameKey] || '', ''
                ]);

                doc.autoTable({
                    startY: doc.autoTable.previous.finalY + 4,
                    head: [['S.No.', 'ENROLLMENT NO.', 'NAME OF STUDENT', 'SIGNATURE']],
                    body: studentTableData,
                    theme: 'grid',
                    styles: { fontSize: 8, cellPadding: 2, halign: 'center', textColor: [0, 0, 0], lineColor: [0, 0, 0], lineWidth: 0.1 },
                    headStyles: { fillColor: [255, 255, 255], textColor: [0, 0, 0], lineWidth: 0.1, lineColor: [0, 0, 0] },
                    columnStyles: { 0: { cellWidth: 10 }, 1: { cellWidth: 30 }, 2: { cellWidth: 60, halign: 'left' }, 3: { cellWidth: 'auto' } }
                });

                let finalY = doc.autoTable.previous.finalY;
                const pageHeight = doc.internal.pageSize.getHeight();
                const requiredFooterHeight = 75;

                if (pageHeight - finalY < requiredFooterHeight) {
                    doc.addPage();
                    finalY = 15;
                }

                const statsTableData = [
                    ["Total No. of Students", "Present Students", "Absent Students", "Answerbook Used", "Supplementary Used", "Malpractice Reported"],
                    [examDetails.totalStudentsInBlock, "", "", "", "", ""]
                ];
                
                doc.autoTable({
                    startY: finalY + 10,
                    head: [statsTableData[0]],
                    body: [statsTableData[1]],
                    theme: 'grid',
                    styles: { fontSize: 8, halign: 'center', cellPadding: 2, textColor: [0, 0, 0], lineColor: [0, 0, 0], lineWidth: 0.1 },
                    headStyles: { fillColor: [255, 255, 255], textColor: [0, 0, 0], fontStyle: 'bold', lineColor: [0, 0, 0], lineWidth: 0.1 }
                });

                finalY = doc.autoTable.previous.finalY;
                
                const disclaimerY = finalY + 8;
                doc.setFontSize(8);
                doc.text("I HEREBY DECLARE THAT I HAVE VERIFIED ABOVE MENTIONED DETAILS AND ALSO DECLARE THAT STUDENTS HAVE RETURNED THESE ANSWER BOOKS AS MENTIONED ABOVE.", 15, disclaimerY, { maxWidth: pageWidth - 30 });
                
                const signatureY = disclaimerY + 20;
                const signatureLineSpacing = 4;
                doc.setFontSize(9);
                
                doc.text("SIGNATURE INVIGILATOR", 20, signatureY);
                doc.text("SIGNATURE", pageWidth / 2, signatureY, { align: "center" });
                doc.text("Deputy Chief Superintendent", pageWidth / 2, signatureY + signatureLineSpacing, { align: "center" });
                doc.text("SIGNATURE", pageWidth - 20, signatureY, { align: "right" });
                doc.text("Chief Superintendent", pageWidth - 20, signatureY + signatureLineSpacing, { align: "right" });
            }

            // --- General Utility Functions ---
            function showStatus(element, message, type) {
                const statusClass = { 'success': 'status-success', 'warn': 'status-warn', 'error': 'status-error' };
                element.className = `status-box ${statusClass[type]}`;
                element.textContent = message;
            }
            
            function resetApp() {
                location.reload();
            }

            function initializePickers() {
                flatpickr("#exam-date", {
                    altInput: true,
                    altFormat: "F j, Y",
                    dateFormat: "d-m-Y",
                    defaultDate: "today"
                });
                flatpickr("#exam-time", {
                    enableTime: true,
                    noCalendar: true,
                    dateFormat: "h:i K",
                    defaultDate: new Date()
                });
            }
            
            async function preloadLogo() {
                try {
                    const response = await fetch('itmbu_logo.png');
                    if (!response.ok) throw new Error('Logo not found at ./itmbu_logo.png');
                    const blob = await response.blob();
                    const reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onloadend = () => {
                        state.logoBase64 = reader.result;
                        console.log('Local logo preloaded successfully.');
                    };
                } catch (error) {
                    console.warn('Could not preload local logo:', error);
                }
            }


            // Initial setup
            populateAcademicYears();
            initializePickers();
            preloadLogo();
            navigateToStep(1);
        });
    </script>
</body>
</html>
