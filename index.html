<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Sheet Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Lucide Icons for better iconography -->
    <script src="https://unpkg.com/lucide@latest"></script> 
    <style>
        /* --- Official University Brand Color (Deep Maroon: #8e001a) --- */
        :root {
            --color-primary: #8e001a;
            --color-primary-light: #c20025;
            --color-primary-extralight: #fce7f3; /* Used for subtle highlights */
            --color-secondary: #0a4f36; /* Dark green accent for success (Next/Go) */
        }
        
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .app-container { max-width: 1024px; margin: 1rem auto; }
        .step-section { transition: all 0.3s ease; border: 1px solid #e2e8f0; }
        
        /* Enhanced Typography */
        .step-header { font-weight: 800; font-size: 1.6rem; color: var(--color-primary); margin-bottom: 1rem; border-bottom: 3px solid var(--color-primary-extralight); padding-bottom: 0.5rem; }
        
        input[type="file"] { display: none; }
        
        /* Primary Action Button (File Upload) */
        .custom-file-upload { display: inline-block; cursor: pointer; padding: 14px 28px; border-radius: 50px; background-color: var(--color-primary); color: #ffffff; font-weight: 600; transition: background-color 0.3s ease; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .custom-file-upload:hover { background-color: var(--color-primary-light); }
        
        .action-button { 
            padding: 12px 24px; 
            border-radius: 50px; 
            font-weight: 600; 
            transition: all 0.2s ease; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .action-button:hover { transform: translateY(-2px); }
        .action-button:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none; }
        
        /* Next/Main Action Button (Green for progression) */
        .next-button { background-color: var(--color-secondary); color: #ffffff; }
        .next-button:hover:not(:disabled) { background-color: #0d6e4b; }

        /* Secondary/Back Button (Neutral) */
        .back-button { background-color: #e2e8f0; color: #1e293b; }
        .back-button:hover:not(:disabled) { background-color: #cbd5e1; }
        
        /* PDF Button (Blue/Indigo) */
        .pdf-button { background-color: #4f46e5; color: white; }
        .pdf-button:hover:not(:disabled) { background-color: #4338ca; }

        /* Input Styling */
        .input-group input, .input-group select, .input-group textarea { padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; width: 100%; transition: border-color 0.3s ease, box-shadow 0.3s ease; background-color: white; }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(142, 0, 26, 0.2); }
        
        /* Validation Error State */
        .input-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
            animation: shake 0.3s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        /* Status Boxes */
        .status-box { padding: 12px; border-radius: 10px; font-weight: 500; margin-top: 1rem; }
        .status-success { background-color: #dcfce7; color: var(--color-secondary); }
        .status-error { background-color: #fee2e2; color: #ef4444; }
        .status-warn { background-color: #fef9c3; color: #ca8a04; }
        
        /* Summary Box */
        .summary-box { border: 2px solid var(--color-primary); background-color: var(--color-primary-extralight); padding: 1rem; border-radius: 12px; font-weight: 600; color: var(--color-primary); }
        .remove-block-btn { background-color: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 16px; cursor: pointer; line-height: 1; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s ease; }
        .remove-block-btn:hover { background-color: #dc2626; }
        
        /* Stepper */
        .stepper { display: flex; justify-content: space-between; margin-bottom: 2rem; position: relative; }
        .step { text-align: center; flex: 1; }
        .step-circle { width: 40px; height: 40px; border-radius: 50%; background-color: #e2e8f0; color: #64748b; display: flex; align-items: center; justify-content: center; margin: 0 auto 0.5rem; font-weight: 600; transition: all 0.3s ease; border: 2px solid transparent; }
        .step-label { font-size: 0.875rem; color: #64748b; font-weight: 500; }
        .step.active .step-circle { background-color: var(--color-primary); color: white; border-color: var(--color-primary-light); }
        .step.active .step-label { color: #1e293b; }
        .stepper::before { content: ''; position: absolute; top: 20px; left: 10%; right: 10%; height: 2px; background-color: #e2e8f0; transform: translateY(-50%); z-index: -1; }
        
        /* Split Button Styles */
        .split-button-group {
            display: flex;
            flex-direction: column;
            gap: 8px; /* Gap for mobile stacking */
            width: 100%;
        }

        @media (min-width: 640px) {
            .split-button-group {
                flex-direction: row;
                gap: 0; /* Remove gap when side-by-side */
                width: auto;
            }
            .split-button-group > button {
                border-radius: 0; /* Make buttons rectangular in desktop view */
            }
            .split-button-group > button:first-child {
                border-top-left-radius: 50px;
                border-bottom-left-radius: 50px;
            }
            .split-button-group > button:last-child {
                border-top-right-radius: 50px;
                border-bottom-right-radius: 50px;
            }
        }

        /* Tabbed Source Selection Styling */
        .tab-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 16px;
            font-weight: 600;
            border-bottom-width: 2px;
            border-color: transparent;
            color: #64748b;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .tab-button.active {
            color: var(--color-primary);
            border-color: var(--color-primary);
            background-color: var(--color-primary-extralight);
        }
        .tab-button:not(.active):hover {
            color: #1e293b;
        }

        /* Section Cards for Step 3 */
        .detail-card {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        .detail-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background-color: var(--color-primary);
        }
        .detail-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            color: #334155;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        /* Toggle Card Style */
        .toggle-card {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .toggle-card:hover {
            background-color: #f8fafc;
            border-color: #94a3b8;
        }
        .toggle-card input:checked + label {
            color: var(--color-primary);
            font-weight: 600;
        }
        
        /* Queue Table Styles */
        .queue-table { width: 100%; border-collapse: separate; border-spacing: 0; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        .queue-table th { background-color: #f8fafc; color: #64748b; font-weight: 600; font-size: 0.85rem; padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .queue-table td { padding: 12px; border-bottom: 1px solid #e2e8f0; color: #334155; font-size: 0.9rem; }
        .queue-table tr:last-child td { border-bottom: none; }
        .queue-table tr:hover td { background-color: #f9fafb; }
        
        .btn-icon { padding: 6px; border-radius: 6px; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .btn-icon-danger { color: #ef4444; background-color: #fee2e2; }
        .btn-icon-danger:hover { background-color: #fecaca; }
        .btn-icon-primary { color: var(--color-primary); background-color: var(--color-primary-extralight); }
        .btn-icon-primary:hover { background-color: #fbcfe8; }
        .btn-icon-neutral { color: #475569; background-color: #e2e8f0; }
        .btn-icon-neutral:hover { background-color: #cbd5e1; }
        .btn-icon-blue { color: #4f46e5; background-color: #e0e7ff; }
        .btn-icon-blue:hover { background-color: #c7d2fe; }

        /* Bento Grid Styles */
        .bento-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        @media (min-width: 768px) {
            .bento-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        .bento-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: all 0.2s;
        }
        .bento-card-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: #1e293b;
            line-height: 1.2;
        }
        .bento-card-label {
            font-size: 0.8rem;
            color: #64748b;
            font-weight: 500;
        }

    </style>
</head>
<body class="p-2 sm:p-4">
    <div class="app-container bg-white p-4 sm:p-8 rounded-2xl shadow-lg">
        <img id="site-banner" src="site_banner.png" alt="Exam Banner" class="w-full h-auto rounded-lg mb-8 shadow-md" onerror="this.style.display='none'">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-center mb-8 text-slate-800">Attendance Sheet Creator</h1>

        <div class="stepper mb-10">
            <div id="stepper-1" class="step"><div class="step-circle">1</div><div class="step-label">Source Data</div></div>
            <div id="stepper-2" class="step"><div class="step-circle">2</div><div class="step-label">Define Blocks</div></div>
            <div id="stepper-3" class="step"><div class="step-circle">3</div><div class="step-label">Exam Details</div></div>
        </div>

        <div id="step-1" class="step-section p-4 sm:p-6 rounded-lg">
            
            <!-- Tab Toggle for Modes -->
            <div class="flex border-b border-gray-200 mb-6 -mx-4 sm:mx-0">
                <button id="mode-file-btn" class="tab-button active w-1/2">
                     <i data-lucide="upload" class="w-5 h-5 mr-2"></i>
                     Regular Exam (Source)
                </button>
                <button id="mode-blank-btn" class="tab-button w-1/2">
                    <i data-lucide="clipboard-pen" class="w-5 h-5 mr-2"></i>
                    Blank Sheet Template
                </button>
            </div>

            <!-- Content for File Upload Mode -->
            <div id="file-upload-content">
                <div class="step-header">Step 1: Load Student Data</div>
                <p class="text-slate-600 mb-6">Choose how you want to load your student data. The university logo will be added automatically to the PDF.</p>
                
                <!-- Input Method Split Button -->
                <div class="bg-slate-100 p-1 rounded-lg inline-flex mb-6 w-full sm:w-auto">
                    <button id="toggle-upload-btn" class="px-6 py-2 rounded-md text-sm font-bold bg-white shadow text-slate-800 transition-all w-1/2 sm:w-auto" onclick="switchInputMethod('upload')">
                        Upload File
                    </button>
                    <button id="toggle-paste-btn" class="px-6 py-2 rounded-md text-sm font-bold text-slate-500 hover:text-slate-800 transition-all w-1/2 sm:w-auto" onclick="switchInputMethod('paste')">
                        Paste Data Directly
                    </button>
                </div>

                <!-- Method 1: File Upload -->
                <div id="input-method-upload" class="mt-2 transition-all">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 border-2 border-dashed border-slate-300 rounded-xl p-8 bg-slate-50 justify-center text-center sm:text-left">
                        <label for="student-file" class="custom-file-upload w-full sm:w-auto text-center cursor-pointer hover:scale-105 transition-transform">
                            <i data-lucide="file-text" class="w-5 h-5 mr-2 inline-block"></i>Choose Excel/CSV
                        </label>
                        <input type="file" id="student-file" accept=".csv, .xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                        <div class="flex flex-col">
                            <span id="file-name" class="text-slate-800 font-medium truncate">No file selected</span>
                            <span class="text-xs text-slate-500">Supported formats: .xlsx, .csv</span>
                        </div>
                    </div>
                </div>

                <!-- Method 2: Paste Data -->
                <div id="input-method-paste" class="hidden mt-2 transition-all">
                    <div class="w-full">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Paste Excel Data (Columns: Enrollment, Name)</label>
                        <textarea id="paste-area" rows="8" class="w-full p-4 border border-slate-300 rounded-xl font-mono text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Example:&#10;23C11001	Rohit Sharma&#10;23C11002	Anant Tank"></textarea>
                        <div class="flex flex-col sm:flex-row justify-between mt-4 gap-2">
                             <!-- Mobile Clean Paste Button -->
                            <button id="clean-paste-btn" class="action-button bg-gray-200 text-gray-700 hover:bg-gray-300 text-sm sm:hidden" onclick="window.formatPasteData()">
                                <i data-lucide="clipboard-check" class="w-4 h-4 mr-2"></i>Clean Paste (Mobile)
                            </button>
                            <button id="process-paste-btn" class="action-button bg-indigo-600 text-white hover:bg-indigo-700">
                                <i data-lucide="cpu" class="w-4 h-4 mr-2"></i>Process Pasted Data
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- REMOVED FORMAT GUIDE AS REQUESTED -->

            </div>
            
            <!-- Content for Blank Sheet Mode -->
            <div id="blank-sheet-content" class="hidden">
                 <div class="step-header">Step 1: Blank Sheet Template</div>
                 <p class="text-slate-600 mb-6">Generate empty attendance sheets for manual entry. You will define the total number of blank rows and block details in the next step.</p>
                 <div class="flex justify-end mt-6">
                     <button id="next-to-step2-blank-btn" class="action-button next-button w-full sm:w-auto">
                        Next 
                        <i data-lucide="arrow-right" class="w-5 h-5 ml-2"></i>
                     </button>
                 </div>
            </div>
            
            
            <!-- DATA HEALTH & CLEANING SECTION -->
            <div id="data-cleaning-section" class="hidden mt-8 border-t-2 border-slate-200 pt-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                
                <!-- 1. Health Dashboard (Bento Box) -->
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center">
                        <i data-lucide="activity" class="w-6 h-6 inline-block mr-2 text-indigo-600"></i>
                        Data Health Dashboard
                    </h2>
                    <span class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-full">Live Analysis</span>
                </div>

                <div class="bento-grid">
                    <!-- Metric: Total Rows -->
                    <div class="bento-card">
                        <div class="bento-card-value" id="metric-rows">0</div>
                        <div class="bento-card-label">Total Students</div>
                    </div>
                    <!-- Metric: Columns -->
                    <div class="bento-card">
                        <div class="bento-card-value" id="metric-cols">0</div>
                        <div class="bento-card-label">Data Columns</div>
                    </div>
                    <!-- System Status -->
                    <div class="bento-card col-span-2 border-l-4 relative overflow-hidden" id="status-card">
                        <div class="flex justify-between items-center h-full relative z-10">
                            <div>
                                <div class="text-sm text-slate-500 font-semibold uppercase tracking-wide mb-1">System Status</div>
                                <div class="text-lg font-bold text-slate-800" id="status-text">Waiting for Input</div>
                            </div>
                            <!-- Updated Status Icon will be set by JS (REMOVED WAITING ICON) -->
                            <!-- Using a div container that can be empty or filled -->
                            <div id="status-icon-wrapper"></div>
                        </div>
                        <!-- Color bar indicator on right -->
                        <div id="status-bar" class="absolute right-0 top-0 bottom-0 w-1.5 bg-slate-300"></div>
                    </div>
                    <!-- Danger Card (Duplicates) - Hidden by default -->
                    <div id="duplicate-card" class="bento-card col-span-2 sm:col-span-4 bg-red-50 border-red-200 hidden">
                        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                            <div class="flex items-center gap-3">
                                <div class="bg-red-100 p-2 rounded-full">
                                    <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-red-800 text-lg">Duplicates Detected</div>
                                    <div class="text-sm text-red-600">Found <span id="duplicate-count" class="font-bold">0</span> duplicate enrollment numbers.</div>
                                </div>
                            </div>
                            <div class="flex gap-2 w-full sm:w-auto">
                                <button onclick="window.viewDuplicates()" class="px-4 py-2 bg-white border border-red-200 text-red-700 rounded-lg text-sm font-semibold hover:bg-red-50 flex-1 sm:flex-none">View List</button>
                                <button onclick="window.deduplicateAndRevalidate()" class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-semibold hover:bg-red-700 shadow-sm flex-1 sm:flex-none">Fix & Continue</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Context Aware Cleaning Layout (Refined Bento Layout) -->
                <div class="mt-6">
                    
                    <!-- Controls Grid (Side by Side on Desktop, Stacked on Mobile) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        
                        <!-- Parser Settings Card -->
                        <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm h-full">
                            <h3 class="font-semibold text-slate-800 mb-4 flex items-center">
                                <i data-lucide="sliders-horizontal" class="w-4 h-4 mr-2"></i>
                                Parser Settings
                            </h3>
                            <div class="space-y-4">
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Skip Top Rows</label>
                                    <input type="number" id="skip-rows" value="0" min="0" class="w-full bg-slate-50" oninput="liveUpdatePreview()">
                                </div>
                                <div class="toggle-card justify-between">
                                    <label for="force-header-toggle" class="text-sm text-slate-800 font-medium cursor-pointer select-none">Use First Row as Header</label>
                                    <input type="checkbox" id="force-header-toggle" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" onchange="liveUpdatePreview()">
                                </div>
                            </div>
                        </div>

                        <!-- Mapping Card (Green Highlight) -->
                        <div class="p-5 rounded-xl border-2 border-green-400 bg-green-50 shadow-md relative overflow-hidden h-full">
                            <div class="absolute top-0 right-0 bg-green-200 text-green-800 text-[10px] font-bold px-2 py-1 rounded-bl-lg">REQUIRED</div>
                            <h3 class="font-bold text-green-900 mb-4 flex items-center">
                                <i data-lucide="map" class="w-5 h-5 mr-2"></i>
                                Column Mapping
                            </h3>
                            <p class="text-xs text-green-700 mb-4 leading-relaxed">Link your file's columns to the app's logic.</p>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold uppercase text-green-800 mb-1">Enrollment No.</label>
                                    <select id="enrollment-map" class="border-green-300 focus:border-green-500 focus:ring-green-200" onchange="finalizeDataCleaningAndMapping()"></select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold uppercase text-green-800 mb-1">Student Name</label>
                                    <select id="name-map" class="border-green-300 focus:border-green-500 focus:ring-green-200" onchange="finalizeDataCleaningAndMapping()"></select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- REMOVED CONFIRM BUTTON -->

                    <!-- Live Preview Table (Full Width Below) -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col">
                        <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
                            <h3 class="font-semibold text-slate-700 text-sm flex items-center">
                                <i data-lucide="table" class="w-4 h-4 mr-2 text-slate-400"></i>
                                Live Data Preview
                            </h3>
                            <span id="preview-interpretation" class="text-[10px] font-bold px-2 py-1 rounded bg-gray-200 text-gray-600">RAW</span>
                        </div>
                        <div class="overflow-auto flex-1 rounded-b-xl" style="max-height: 400px;">
                            <table id="live-preview-table" class="min-w-full divide-y divide-slate-200 text-xs">
                                <thead class="bg-slate-50 sticky top-0 z-10 shadow-sm text-slate-500"></thead>
                                <tbody class="divide-y divide-slate-100 bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="data-preview-section" class="hidden mt-6"></div> <!-- Legacy container kept for layout safety -->
            
            <!-- Status box for validation messages -->
            <div id="file-status" class="status-box hidden mt-6"></div>

            <div class="flex justify-end mt-6">
                 <button id="next-to-step2-btn" class="action-button next-button w-full sm:w-auto hidden">
                    Next Step: Define Blocks
                    <i data-lucide="arrow-right" class="w-5 h-5 ml-2"></i>
                 </button>
            </div>
        </div>

        <!-- Step 2 & 3 remain largely unchanged in structure but use the new data flow -->
        <div id="step-2" class="step-section mt-8 hidden p-4 sm:p-6 rounded-lg">
            <div class="step-header">Step 2: Define Exam Blocks</div>
            <p class="text-slate-600 mb-6">Allocate students into blocks. You can create one special block for a specific enrollment range, and then allocate the rest by count.</p>

            <div id="show-range-block-container" class="mb-6 text-center border border-dashed border-gray-300 p-4 rounded-lg hover:border-indigo-400 transition-colors cursor-pointer">
                <button id="show-range-block-btn" class="text-indigo-600 font-semibold w-full">
                    <i data-lucide="split-square-horizontal" class="w-5 h-5 inline-block mr-1"></i>
                    Create a Block by Enrollment Range (Optional)
                </button>
            </div>

            <div id="range-block-section" class="hidden mb-8 p-4 border border-dashed border-indigo-300 rounded-lg bg-indigo-50">
                <h3 class="font-semibold text-lg text-indigo-800 mb-3">Optional: Create a Block by Enrollment Range</h3>
                <div id="range-block-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="input-group md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Start Enrollment No.</label><input type="text" id="start-enrollment" placeholder="e.g., 24C24510"></div>
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">End Enrollment No.</label><input type="text" id="end-enrollment" placeholder="e.g., 24C24530"></div>
                    </div>
                     <div class="input-group"><label class="block text-sm font-medium text-slate-700 mb-1">Exam Centre</label><select id="range-block-center"><option value="">Select Center</option><option value="SOB">SOB</option><option value="SOP">SOP</option><option value="SOCSET" selected>SOCSET</option></select></div>
                     <div class="input-group"><label class="block text-sm font-medium text-slate-700 mb-1">Room No.</label><input type="text" id="range-block-room-no" placeholder="e.g., EB 54"></div>
                     <div class="input-group"><label class="block text-sm font-medium text-slate-700 mb-1">Block No.</label><input type="text" id="range-block-no" placeholder="e.g., 5"></div>
                     <div class="md:col-span-2 flex justify-end items-center"><button id="create-range-block-btn" class="action-button bg-indigo-600 text-white hover:bg-indigo-700" onclick="window.createSpecialBlock()">Create Special Block</button></div>
                </div>
                 <div id="range-block-status" class="status-box hidden"></div>
            </div>
            
            <div class="summary-box mb-6 text-sm sm:text-base">
                Total Students: <span id="total-students-original">0</span> | 
                Students to Allocate: <span id="total-students-to-allocate">0</span>
            </div>

            <hr class="my-6">
            <h3 class="font-semibold text-lg text-slate-800 mb-3 flex justify-between items-center">
                <span>Allocate Remaining Students</span>
                <button id="toggle-auto-distribute" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium underline flex items-center">
                    <i data-lucide="wand-2" class="w-4 h-4 mr-1"></i> Auto-Distribute
                </button>
            </h3>

            <!-- Auto Distribute UI with Bento Options -->
            <div id="auto-distribute-panel" class="hidden mb-6 bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                <h4 class="text-sm font-bold text-indigo-800 mb-3">Auto-Distribute Method</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <!-- Option 1: By Total Blocks -->
                    <label class="flex items-start p-3 border rounded-lg bg-white hover:border-indigo-400 cursor-pointer transition-colors">
                        <input type="radio" name="dist-method" value="count" checked class="mt-1 mr-3 text-indigo-600 focus:ring-indigo-500" onclick="toggleDistInput('count')">
                        <div>
                            <span class="block font-bold text-slate-700 text-sm">Split into N Blocks</span>
                            <span class="text-xs text-slate-500">Divide students equally among a fixed number of blocks.</span>
                        </div>
                    </label>
                    <!-- Option 2: By Capacity -->
                    <label class="flex items-start p-3 border rounded-lg bg-white hover:border-indigo-400 cursor-pointer transition-colors">
                        <input type="radio" name="dist-method" value="capacity" class="mt-1 mr-3 text-indigo-600 focus:ring-indigo-500" onclick="toggleDistInput('capacity')">
                        <div>
                            <span class="block font-bold text-slate-700 text-sm">Fill by Capacity</span>
                            <span class="text-xs text-slate-500">Create blocks based on a max number of students per block.</span>
                        </div>
                    </label>
                </div>

                <div class="flex items-end gap-4">
                    <div class="input-group w-full">
                        <label class="block text-xs font-medium text-slate-700 mb-1" id="dist-input-label">Number of Blocks needed</label>
                        <input type="number" id="auto-dist-count" class="w-full" placeholder="e.g. 4" min="1">
                    </div>
                    <button id="apply-auto-distribute" class="action-button bg-indigo-600 text-white hover:bg-indigo-700 h-[45px]">
                        Apply
                    </button>
                </div>
                <p class="text-xs text-indigo-600 mt-2">This will replace existing blocks.</p>
            </div>

            <div id="blocks-container"></div>
            <div class="flex items-center justify-between mt-6">
                <button id="add-block" class="action-button back-button text-sm sm:text-base">
                    <i data-lucide="plus" class="w-4 h-4 mr-1"></i>
                    Add Block
                </button>
                <div id="student-count-status" class="status-box hidden p-2 text-sm mt-0"></div>
            </div>
            
            <div id="step2-error" class="text-red-500 text-sm font-semibold mt-4 hidden text-right">Please fill in Room No and Block No for all blocks.</div>

            <div class="flex justify-between mt-8 gap-4">
                <button id="back-to-step1-btn" class="action-button back-button w-full sm:w-auto" onclick="navigateToStep(1)">
                    <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i>
                    Back
                </button>
                <button id="next-to-step3-btn" class="action-button next-button w-full sm:w-auto" disabled>
                    Next 
                    <i data-lucide="arrow-right" class="w-5 h-5 ml-2"></i>
                </button>
            </div>
        </div>

        <div id="step-3" class="step-section mt-8 hidden p-4 sm:p-6 rounded-lg">
            <div class="step-header">Step 3: Exam Schedule & Generation</div>
            <p class="text-slate-600 mb-6">Set your global academic details, then build your exam schedule.</p>
            
            <!-- NEW: Bento Grid for Step 3 (Global & Add Exam) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                
                <!-- 1. Global Context Card -->
                <div class="detail-card h-full">
                    <div class="detail-card-header">
                        <i data-lucide="graduation-cap" class="w-5 h-5 mr-2 text-indigo-600"></i>
                        Global Settings (All Exams)
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div class="input-group">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Branch</label>
                            <select id="branch" class="persist-input">
                                <option value="">Select Branch</option>
                                <option value="BTECH">BTECH</option>
                                <option value="DIPLOMA">DIPLOMA</option>
                                <option value="BCA">BCA</option>
                                <option value="MCA">MCA</option>
                                <option value="MTECH">MTECH</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Semester</label>
                            <select id="semester" class="persist-input">
                                <option value="">Select Semester</option>
                                <option value="Semester - 1">Semester - 1</option>
                                <option value="Semester - 2">Semester - 2</option>
                                <option value="Semester - 3">Semester - 3</option>
                                <option value="Semester - 4">Semester - 4</option>
                                <option value="Semester - 5">Semester - 5</option>
                                <option value="Semester - 6">Semester - 6</option>
                                <option value="Semester - 7">Semester - 7</option>
                                <option value="Semester - 8">Semester - 8</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Specialization</label>
                             <select id="specialization" class="persist-input">
                                <option value="">Select Specialization</option>
                                <option value="CSE">CSE</option>
                                <option value="IT">IT</option>
                                <option value="AI">AI</option>
                                <option value="CSN">CSN</option>
                                <option value="CSA">CSA</option>
                                <option value="COMBINED">COMBINED</option>
                                <option value="N/A">N/A</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Academic Year</label>
                            <select id="academic-year" class="persist-input"></select>
                        </div>
                        <!-- Toggle Options -->
                        <div class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="toggle-card">
                                 <input type="checkbox" id="is-remedial-exam" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 persist-check mr-3">
                                 <label for="is-remedial-exam" class="block text-sm text-slate-800 font-medium cursor-pointer">Is this a Remedial Exam?</label>
                            </div>
                            <div class="toggle-card">
                                 <input type="checkbox" id="include-subject-column" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 persist-check mr-3">
                                 <label for="include-subject-column" class="block text-sm text-slate-800 font-medium cursor-pointer">Include Subject Column</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Add Exam Card -->
                <div class="detail-card border-l-4 border-l-indigo-500 h-full flex flex-col justify-between">
                    <div>
                        <div class="detail-card-header flex justify-between items-center w-full">
                            <div class="flex items-center">
                                <i data-lucide="calendar-plus" class="w-5 h-5 mr-2 text-indigo-600"></i>
                                Add Exam to Schedule
                            </div>
                            <span class="text-xs font-normal text-indigo-500 bg-indigo-50 px-2 py-1 rounded">
                                Tip: Press <span class="font-bold">Enter</span> to Add
                            </span>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-4">
                            <div class="input-group">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Course Code</label>
                                <input type="text" id="course-code" class="persist-input queue-input" placeholder="e.g., C4361C1">
                            </div>
                            <div class="input-group">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Course Name</label>
                                <input type="text" id="course-name" class="persist-input queue-input" placeholder="e.g., Data Structures">
                            </div>
                            <div class="input-group">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Exam Date</label>
                                <input type="text" id="exam-date" class="queue-input" placeholder="Select Date...">
                            </div>
                            <div class="input-group">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Exam Time</label>
                                <input type="text" id="exam-time" class="queue-input" placeholder="Select Time...">
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-end">
                            <button id="add-exam-btn" class="action-button bg-indigo-600 text-white hover:bg-indigo-700 w-full sm:w-auto">
                                <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                                Add to Schedule
                            </button>
                        </div>
                        <div id="add-exam-error" class="text-red-500 text-sm mt-2 text-right hidden">Please fill all exam details.</div>
                    </div>
                </div>
            </div>

            <!-- 3. Exam Queue (The Schedule) - Full Width -->
            <div id="queue-section" class="hidden mb-8">
                <div class="flex justify-between items-end mb-4">
                    <h3 class="text-lg font-bold text-slate-800 flex items-center">
                        <i data-lucide="list-checks" class="w-5 h-5 mr-2 text-green-600"></i>
                        Exam Schedule Queue
                    </h3>
                    <button id="sort-queue-btn" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium underline flex items-center">
                        <i data-lucide="arrow-up-down" class="w-4 h-4 mr-1"></i> Sort by Date
                    </button>
                </div>
                <div class="overflow-x-auto rounded-lg border border-slate-200">
                    <table class="queue-table w-full">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Course Details</th>
                                <th>Date & Time</th>
                                <th class="text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="exam-queue-body">
                            <!-- Rows injected via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col lg:flex-row justify-between mt-8 gap-4 items-center">
                <div class="flex flex-col sm:flex-row gap-4 w-full lg:w-auto">
                    <button id="back-to-step2-btn" class="action-button back-button w-full sm:w-auto" onclick="window.backToStep2()">
                        <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i>
                        Back
                    </button>
                    <button id="edit-step1-btn" class="action-button back-button w-full sm:w-auto" onclick="navigateToStep(1)">
                        <i data-lucide="file-edit" class="w-5 h-5 mr-2"></i>
                        Edit Source
                    </button>
                    <button id="download-all-combined-btn" class="action-button pdf-button w-full sm:w-auto hidden">
                        <i data-lucide="file-down" class="w-5 h-5 mr-2"></i>
                        Download All Combined (PDF)
                    </button>
                </div>
            </div>
        </div>

        <footer class="text-center mt-10 text-xs text-slate-500">
            <p>Created by Neel Patel</p>
        </footer>
    </div>
    
    <div id="loading-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-60 items-center justify-center hidden z-50">
        <div class="text-white text-center">
            <svg class="animate-spin h-10 w-10 text-white mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg font-semibold">Processing...</p>
        </div>
    </div>

    <!-- Duplicates Modal -->
    <div id="duplicates-modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 hidden z-50 items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full overflow-hidden flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-slate-100 bg-red-50 flex justify-between items-center">
                <h3 class="font-bold text-red-800 flex items-center"><i data-lucide="alert-circle" class="w-5 h-5 mr-2"></i>Duplicate Enrollments</h3>
                <button onclick="document.getElementById('duplicates-modal').classList.add('hidden')" class="text-slate-500 hover:text-slate-800">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                <ul id="duplicates-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 font-mono"></ul>
            </div>
            <div class="p-4 border-t border-slate-100 text-right">
                 <button onclick="document.getElementById('duplicates-modal').classList.add('hidden')" class="action-button back-button text-xs">Close</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { jsPDF } = window.jspdf;

            // Global state
            const state = {
                studentData: [],
                totalStudentsInFile: 0,
                studentsToAllocateCount: 0,
                enrollmentNoKey: 'Enrollment No.', 
                studentNameKey: 'Student Name',     
                blockCount: 0,
                rawHeaders: [],
                tempJsonData: [],
                logoBase64: null,
                isBlankSheet: false, 
                allocatedBlocks: [],
                examQueue: [], 
                
                // Raw AoA data for live cleaning
                rawAoA: [],
                inferredHeaderStatus: false,
                currentDuplicates: []
            };

            // DOM elements
            const ui = {
                studentFile: document.getElementById('student-file'),
                fileNameSpan: document.getElementById('file-name'),
                fileStatus: document.getElementById('file-status'),
                nextToStep2Btn: document.getElementById('next-to-step2-btn'),
                nextToStep2BlankBtn: document.getElementById('next-to-step2-blank-btn'),
                nextToStep3Btn: document.getElementById('next-to-step3-btn'),
                step2Error: document.getElementById('step2-error'), // NEW Validation Error Box
                
                addExamBtn: document.getElementById('add-exam-btn'),
                downloadAllCombinedBtn: document.getElementById('download-all-combined-btn'),
                queueSection: document.getElementById('queue-section'),
                examQueueBody: document.getElementById('exam-queue-body'),
                addExamError: document.getElementById('add-exam-error'),
                sortQueueBtn: document.getElementById('sort-queue-btn'),

                addBlockBtn: document.getElementById('add-block'),
                blocksContainer: document.getElementById('blocks-container'),
                studentCountStatus: document.getElementById('student-count-status'),
                totalStudentsOriginal: document.getElementById('total-students-original'),
                totalStudentsToAllocate: document.getElementById('total-students-to-allocate'),
                loadingOverlay: document.getElementById('loading-overlay'),
                
                // Data Cleaning & Health
                dataCleaningSection: document.getElementById('data-cleaning-section'), 
                enrollmentMap: document.getElementById('enrollment-map'),
                nameMap: document.getElementById('name-map'),
                // confirmCleaningBtn REMOVED
                livePreviewTable: document.getElementById('live-preview-table'),
                skipRowsInput: document.getElementById('skip-rows'),
                forceHeaderToggle: document.getElementById('force-header-toggle'),
                previewInterpretation: document.getElementById('preview-interpretation'),
                
                // Dashboard Cards
                metricRows: document.getElementById('metric-rows'),
                metricCols: document.getElementById('metric-cols'),
                statusCard: document.getElementById('status-card'),
                statusText: document.getElementById('status-text'),
                // Updated to wrapper
                statusIconWrapper: document.getElementById('status-icon-wrapper'),
                
                statusBar: document.getElementById('status-bar'),
                duplicateCard: document.getElementById('duplicate-card'),
                duplicateCount: document.getElementById('duplicate-count'),
                
                // Copy/Paste UI
                toggleUploadBtn: document.getElementById('toggle-upload-btn'),
                togglePasteBtn: document.getElementById('toggle-paste-btn'),
                inputMethodUpload: document.getElementById('input-method-upload'),
                inputMethodPaste: document.getElementById('input-method-paste'),
                pasteArea: document.getElementById('paste-area'),
                processPasteBtn: document.getElementById('process-paste-btn'),

                // NEW: Auto Distribute
                toggleAutoDistributeBtn: document.getElementById('toggle-auto-distribute'),
                autoDistributePanel: document.getElementById('auto-distribute-panel'),
                applyAutoDistributeBtn: document.getElementById('apply-auto-distribute'),
                autoDistCountInput: document.getElementById('auto-dist-count'),
                distInputLabel: document.getElementById('dist-input-label'),
                
                rangeBlock: {
                    section: document.getElementById('range-block-section'),
                    form: document.getElementById('range-block-form'),
                    startEnrollment: document.getElementById('start-enrollment'),
                    endEnrollment: document.getElementById('end-enrollment'),
                    center: document.getElementById('range-block-center'),
                    roomNo: document.getElementById('range-block-room-no'),
                    blockNo: document.getElementById('range-block-no'),
                    createBtn: document.getElementById('create-range-block-btn'),
                    status: document.getElementById('range-block-status'),
                },
                showRangeBlockBtn: document.getElementById('show-range-block-btn'),

                examDetails: {
                    branch: document.getElementById('branch'),
                    semester: document.getElementById('semester'),
                    academicYear: document.getElementById('academic-year'),
                    courseCode: document.getElementById('course-code'),
                    courseName: document.getElementById('course-name'),
                    specialization: document.getElementById('specialization'),
                    examDate: document.getElementById('exam-date'),
                    examTime: document.getElementById('exam-time'),
                    isRemedialExam: document.getElementById('is-remedial-exam'),
                    includeSubjectColumn: document.getElementById('include-subject-column'),
                },
                modeFileBtn: document.getElementById('mode-file-btn'),
                modeBlankBtn: document.getElementById('mode-blank-btn'),
                fileUploadContent: document.getElementById('file-upload-content'),
                blankSheetContent: document.getElementById('blank-sheet-content'),
                backToStep1Btn: document.getElementById('back-to-step1-btn'),
                backToStep2Btn: document.getElementById('back-to-step2-btn'), 
                editStep1Btn: document.getElementById('edit-step1-btn'),
            };
            
            const capitalizedInputs = [
                ui.rangeBlock.roomNo, ui.rangeBlock.blockNo, ui.rangeBlock.startEnrollment, ui.rangeBlock.endEnrollment,
                ui.examDetails.courseCode, ui.examDetails.courseName,
            ].filter(el => el);
            
            function applyAutoCapitalization(element) {
                if (element) {
                    element.addEventListener('input', (e) => {
                        e.target.value = e.target.value.toUpperCase();
                    });
                }
            }
            
            capitalizedInputs.forEach(applyAutoCapitalization);

            // --- Global Export Functions ---
            window.navigateToStep = navigateToStep;
            window.updateStudentCountStatus = updateStudentCountStatus;
            window.liveUpdatePreview = liveUpdatePreview;
            window.createSpecialBlock = createSpecialBlock;
            window.findHeader = findHeader; 
            window.getBlockDetails = getBlockDetails;
            window.switchInputMethod = switchInputMethod;
            window.viewDuplicates = viewDuplicates;
            window.deduplicateAndRevalidate = deduplicateAndRevalidate;
            window.showRangeBlockSection = showRangeBlockSection;
            window.toggleDistInput = toggleDistInput; // New global
            // Added finalize for select change calls in HTML
            window.finalizeDataCleaningAndMapping = finalizeDataCleaningAndMapping;
            
            // New global for mobile format
            window.formatPasteData = function() {
                if(ui.pasteArea) {
                     // Replace spaces that look like tabs (2 or more spaces) with actual tabs
                     // Or just normalize multiple spaces to a tab
                     ui.pasteArea.value = ui.pasteArea.value.replace(/ {2,}/g, '\t');
                }
            };

            window.backToStep2 = function() {
                navigateToStep(2);
                restoreBlockState(); 
            };

            function setupEventListeners() {
                if (ui.studentFile) ui.studentFile.addEventListener('change', handleFile);
                if (ui.processPasteBtn) ui.processPasteBtn.addEventListener('click', handlePasteData);
                if (ui.nextToStep2Btn) ui.nextToStep2Btn.addEventListener('click', () => navigateToStep(2));
                if (ui.nextToStep2BlankBtn) ui.nextToStep2BlankBtn.addEventListener('click', () => navigateToStep(2));
                if (ui.addBlockBtn) ui.addBlockBtn.addEventListener('click', () => addBlockInput());
                if (ui.blocksContainer) ui.blocksContainer.addEventListener('input', window.updateStudentCountStatus); 
                if (ui.nextToStep3Btn) ui.nextToStep3Btn.addEventListener('click', () => {
                    // VALIDATION STEP 2: Check if room/block are filled in all active blocks
                    const blocks = ui.blocksContainer.querySelectorAll('.block-item:not(:has([readonly]))');
                    let isValid = true;
                    blocks.forEach(b => {
                        const r = b.querySelector('.block-room-no');
                        const n = b.querySelector('.block-no');
                        if(!r.value.trim() || !n.value.trim()) {
                            isValid = false;
                            r.classList.add('input-error');
                            n.classList.add('input-error');
                            // Remove error class after animation
                            setTimeout(() => {
                                r.classList.remove('input-error');
                                n.classList.remove('input-error');
                            }, 1000);
                        }
                    });
                    
                    if(!isValid && !state.isBlankSheet) {
                        ui.step2Error.classList.remove('hidden');
                        return;
                    }
                    ui.step2Error.classList.add('hidden');
                    
                    saveBlockState(); 
                    navigateToStep(3);
                });
                
                if (ui.showRangeBlockBtn) ui.showRangeBlockBtn.addEventListener('click', showRangeBlockSection);

                if (ui.modeFileBtn) ui.modeFileBtn.addEventListener('click', () => setTabMode(false));
                if (ui.modeBlankBtn) ui.modeBlankBtn.addEventListener('click', () => setTabMode(true));
                if (ui.backToStep2Btn) ui.backToStep2Btn.addEventListener('click', window.backToStep2);
                // Removed confirm btn listener
                
                if(ui.toggleAutoDistributeBtn) ui.toggleAutoDistributeBtn.addEventListener('click', () => {
                    ui.autoDistributePanel.classList.toggle('hidden');
                });
                if(ui.applyAutoDistributeBtn) ui.applyAutoDistributeBtn.addEventListener('click', applyAutoDistribution);
                
                if(ui.addExamBtn) ui.addExamBtn.addEventListener('click', addExamToQueue);
                if(ui.downloadAllCombinedBtn) ui.downloadAllCombinedBtn.addEventListener('click', generateCombinedQueuePDF);
                
                if(ui.sortQueueBtn) ui.sortQueueBtn.addEventListener('click', sortQueueByDate);

                if(ui.enrollmentMap) ui.enrollmentMap.addEventListener('change', liveUpdatePreview);
                if(ui.nameMap) ui.nameMap.addEventListener('change', liveUpdatePreview);

                document.querySelectorAll('.persist-input').forEach(input => {
                    input.addEventListener('change', (e) => { saveToLocalStorage(e); });
                    input.addEventListener('input', (e) => { saveToLocalStorage(e); });
                });
                document.querySelectorAll('.persist-check').forEach(input => {
                    input.addEventListener('change', (e) => { saveToLocalStorage(e); });
                });
                
                const queueInputs = document.querySelectorAll('.queue-input');
                queueInputs.forEach(input => {
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            addExamToQueue();
                        }
                    });
                });
            }
            
            function showRangeBlockSection() {
                if(ui.rangeBlock.section) ui.rangeBlock.section.classList.remove('hidden');
                const container = document.getElementById('show-range-block-container');
                if(container) container.classList.add('hidden');
            }

            // --- UI Switching Logic ---
            function switchInputMethod(method) {
                const isUpload = method === 'upload';
                ui.toggleUploadBtn.className = isUpload ? "px-6 py-2 rounded-md text-sm font-bold bg-white shadow text-slate-800 transition-all w-1/2 sm:w-auto" : "px-6 py-2 rounded-md text-sm font-bold text-slate-500 hover:text-slate-800 transition-all w-1/2 sm:w-auto";
                ui.togglePasteBtn.className = !isUpload ? "px-6 py-2 rounded-md text-sm font-bold bg-white shadow text-slate-800 transition-all w-1/2 sm:w-auto" : "px-6 py-2 rounded-md text-sm font-bold text-slate-500 hover:text-slate-800 transition-all w-1/2 sm:w-auto";
                
                ui.inputMethodUpload.classList.toggle('hidden', !isUpload);
                ui.inputMethodPaste.classList.toggle('hidden', isUpload);
            }

            function toggleDistInput(type) {
                if (type === 'count') {
                    ui.distInputLabel.textContent = 'Number of Blocks needed';
                    ui.autoDistCountInput.placeholder = 'e.g. 4';
                } else {
                    ui.distInputLabel.textContent = 'Max Students per Block';
                    ui.autoDistCountInput.placeholder = 'e.g. 30';
                }
            }

            // --- Persistence ---
            function saveToLocalStorage(e) {
                const key = 'asm_' + e.target.id;
                const value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
                localStorage.setItem(key, value);
            }
            
            function loadFromLocalStorage() {
                document.querySelectorAll('.persist-input').forEach(input => {
                    const val = localStorage.getItem('asm_' + input.id);
                    if (val) input.value = val;
                });
                document.querySelectorAll('.persist-check').forEach(input => {
                    const val = localStorage.getItem('asm_' + input.id);
                    if (val !== null) input.checked = (val === 'true');
                });
                
                const savedQueue = localStorage.getItem('asm_exam_queue');
                if(savedQueue) {
                    state.examQueue = JSON.parse(savedQueue);
                    renderQueue();
                }
            }
            
            function saveQueueToStorage() {
                localStorage.setItem('asm_exam_queue', JSON.stringify(state.examQueue));
            }

            // --- Exam Queue Logic ---
            function addExamToQueue() {
                const branch = ui.examDetails.branch.value;
                const sem = ui.examDetails.semester.value;
                const spec = ui.examDetails.specialization.value;
                
                let hasError = false;
                if(!branch || !sem) {
                    alert("Please select Branch and Semester in Global Settings."); return;
                }
                
                // Validation for Specialization
                if(!spec || spec === 'Select Specialization') {
                    ui.examDetails.specialization.classList.add('input-error');
                    setTimeout(() => ui.examDetails.specialization.classList.remove('input-error'), 1000);
                    hasError = true;
                }

                const code = ui.examDetails.courseCode.value;
                const name = ui.examDetails.courseName.value;
                const date = ui.examDetails.examDate.value;
                const time = ui.examDetails.examTime.value;

                if(!code || !name || !date || !time) {
                    ui.addExamError.classList.remove('hidden');
                    hasError = true;
                }
                
                if(hasError) {
                    ui.addExamError.classList.remove('hidden');
                    return;
                }
                ui.addExamError.classList.add('hidden');

                const examObj = {
                    id: Date.now(),
                    global: {
                        branch: ui.examDetails.branch.value,
                        semester: ui.examDetails.semester.value,
                        academicYear: ui.examDetails.academicYear.value,
                        specialization: ui.examDetails.specialization.value,
                        isRemedial: ui.examDetails.isRemedialExam.checked,
                        includeSubjectColumn: ui.examDetails.includeSubjectColumn.checked
                    },
                    schedule: {
                        courseCode: code, courseName: name, examDate: date, examTime: time
                    }
                };

                state.examQueue.push(examObj);
                saveQueueToStorage();
                renderQueue();
                
                ui.examDetails.courseCode.value = '';
                ui.examDetails.courseName.value = '';
            }

            function removeExamFromQueue(id) {
                state.examQueue = state.examQueue.filter(ex => ex.id !== id);
                saveQueueToStorage();
                renderQueue();
            }
            
            function editExamInQueue(id) {
                const exam = state.examQueue.find(e => e.id === id);
                if(!exam) return;
                
                ui.examDetails.courseCode.value = exam.schedule.courseCode;
                ui.examDetails.courseName.value = exam.schedule.courseName;
                
                const datePicker = document.querySelector("#exam-date")._flatpickr;
                const timePicker = document.querySelector("#exam-time")._flatpickr;
                if(datePicker) datePicker.setDate(exam.schedule.examDate, true);
                if(timePicker) timePicker.setDate(exam.schedule.examTime, true);
                
                removeExamFromQueue(id);
                ui.addExamBtn.scrollIntoView({behavior: "smooth", block: "center"});
            }
            
            function sortQueueByDate() {
                state.examQueue.sort((a, b) => {
                    const dateA = parseDate(a.schedule.examDate);
                    const dateB = parseDate(b.schedule.examDate);
                    return dateA - dateB;
                });
                saveQueueToStorage();
                renderQueue();
            }
            
            function parseDate(dateStr) {
                if(!dateStr) return 0;
                let d = new Date(dateStr);
                if(!isNaN(d)) return d;
                const parts = dateStr.split(/[-/]/);
                if(parts.length === 3) {
                    return new Date(parts[2], parts[1]-1, parts[0]);
                }
                return 0;
            }

            function renderQueue() {
                const tbody = ui.examQueueBody;
                tbody.innerHTML = '';

                if(state.examQueue.length === 0) {
                    ui.queueSection.classList.add('hidden');
                    ui.downloadAllCombinedBtn.classList.add('hidden');
                    return;
                }

                ui.queueSection.classList.remove('hidden');
                ui.downloadAllCombinedBtn.classList.remove('hidden');

                state.examQueue.forEach((exam, index) => {
                    const tr = document.createElement('tr');
                    tr.className = 'bg-white transition-colors hover:bg-slate-50';
                    
                    tr.innerHTML = `
                        <td class="font-medium text-slate-500">${index + 1}</td>
                        <td>
                            <div class="font-bold text-slate-700">${exam.schedule.courseName}</div>
                            <div class="text-xs text-slate-500">${exam.schedule.courseCode}</div>
                        </td>
                        <td>
                            <div class="font-semibold text-slate-700">${exam.schedule.examDate}</div>
                            <div class="text-xs text-slate-500">${exam.schedule.examTime}</div>
                        </td>
                        <td class="text-right space-x-2">
                            <button class="btn-icon btn-icon-neutral" title="Edit (Move to Input)" onclick="window.editExamInQueue(${exam.id})">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                            <button class="btn-icon btn-icon-blue" title="Download This Exam" onclick="window.generateSingleExamPDF(${exam.id})">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </button>
                            <button class="btn-icon btn-icon-danger" title="Remove" onclick="window.removeExamFromQueue(${exam.id})">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                lucide.createIcons();
            }

            window.removeExamFromQueue = removeExamFromQueue;
            window.editExamInQueue = editExamInQueue;
            
            // ADDED: New function for single exam download logic from row action
            window.generateSingleExamPDF = (id) => {
                const exam = state.examQueue.find(e => e.id === id);
                if(exam) {
                    generatePDF([exam], false); 
                }
            };

            // --- Auto Distribution ---
            function applyAutoDistribution() {
                const distInputVal = parseInt(ui.autoDistCountInput.value);
                if (!distInputVal || distInputVal < 1) {
                    showStatus(ui.studentCountStatus, 'Please enter a valid number.', 'error');
                    return;
                }

                const method = document.querySelector('input[name="dist-method"]:checked').value; // 'count' or 'capacity'

                let totalToDistribute = 0;
                const specialBlock = ui.blocksContainer.querySelector('.block-students[readonly]');
                
                if (state.isBlankSheet) {
                     const total = prompt("For Blank Sheets, please enter the TOTAL number of students you want to accommodate:", "60");
                     if(!total || isNaN(total)) return;
                     totalToDistribute = parseInt(total);
                } else {
                     totalToDistribute = state.studentsToAllocateCount;
                }

                if (totalToDistribute <= 0) {
                     showStatus(ui.studentCountStatus, 'No students available to distribute.', 'warn'); return;
                }

                // Calculate logic
                let blockCount = 0;
                let baseCount = 0;
                let remainder = 0;

                if (method === 'count') {
                    blockCount = distInputVal;
                    baseCount = Math.floor(totalToDistribute / blockCount);
                    remainder = totalToDistribute % blockCount;
                } else {
                    // By Capacity
                    const capacity = distInputVal;
                    blockCount = Math.ceil(totalToDistribute / capacity);
                    baseCount = capacity;
                    // For capacity, we just fill blocks with 'capacity' until last one
                    // remainder logic differs here. We iterate and decrement total.
                }

                // Remove existing regular blocks
                const regularBlocks = ui.blocksContainer.querySelectorAll('.block-item:not(:has([readonly]))');
                regularBlocks.forEach(el => el.remove());
                
                const existingBlocksLen = ui.blocksContainer.querySelectorAll('.block-item').length;

                if (method === 'count') {
                    for (let i = 0; i < blockCount; i++) {
                        const count = (i < remainder) ? baseCount + 1 : baseCount;
                        addBlockInput(false, {
                            count: count,
                            blockNo: (existingBlocksLen + i + 1).toString()
                        });
                    }
                } else {
                    let remaining = totalToDistribute;
                    let i = 0;
                    while(remaining > 0) {
                        const count = Math.min(remaining, baseCount);
                        addBlockInput(false, {
                            count: count,
                            blockNo: (existingBlocksLen + i + 1).toString()
                        });
                        remaining -= count;
                        i++;
                    }
                }

                ui.autoDistributePanel.classList.add('hidden');
                updateStudentCountStatus();
            }

            function saveBlockState() {
                state.allocatedBlocks = [];
                const blockElements = ui.blocksContainer.querySelectorAll('.block-item');
                blockElements.forEach(block => {
                    const isSpecial = block.querySelector('.block-students').hasAttribute('readonly');
                    state.allocatedBlocks.push({
                        center: block.querySelector('.block-center')?.value || '',
                        roomNo: block.querySelector('.block-room-no')?.value || '',
                        blockNo: block.querySelector('.block-no')?.value || '',
                        count: parseInt(block.querySelector('.block-students')?.value) || 0,
                        isSpecial: isSpecial,
                        studentEnrollments: isSpecial ? state.studentData.filter(s => s.isAllocated).map(s => s[state.enrollmentNoKey]) : []
                    });
                });
            }

            function restoreBlockState() {
                ui.blocksContainer.innerHTML = '';
                state.blockCount = 0;
                state.allocatedBlocks.forEach(details => { addBlockInput(details.isSpecial, details); });
                if (!state.isBlankSheet) {
                    state.studentData.forEach(s => s.isAllocated = false);
                    const specialBlockDetails = state.allocatedBlocks.find(b => b.isSpecial);
                    if (specialBlockDetails) {
                        state.studentData.forEach(s => {
                            if (specialBlockDetails.studentEnrollments.includes(s[state.enrollmentNoKey])) s.isAllocated = true;
                        });
                    }
                }
                window.updateStudentCountStatus();
            }

            // --- Step Navigation ---
            function navigateToStep(stepNumber) {
                document.querySelectorAll('.step-section').forEach(sec => sec.classList.add('hidden'));
                const nextStep = document.getElementById(`step-${stepNumber}`);
                if (nextStep) nextStep.classList.remove('hidden');

                document.querySelectorAll('.stepper .step').forEach((step, index) => {
                    step.classList.remove('active');
                    if (index < stepNumber) step.classList.add('active');
                });

                if (stepNumber === 1 && !state.isBlankSheet) {
                    ui.fileUploadContent.classList.remove('hidden');
                    ui.dataCleaningSection.classList.add('hidden');
                }
                lucide.createIcons();

                if (stepNumber === 2) {
                    if (state.isBlankSheet) {
                        const rangeContainer = document.getElementById('show-range-block-container');
                        if(rangeContainer) rangeContainer.classList.add('hidden'); 
                        
                        if(ui.rangeBlock.section) ui.rangeBlock.section.classList.add('hidden');
                        if (ui.blocksContainer.children.length === 0) {
                            state.studentsToAllocateCount = 0; ui.blocksContainer.innerHTML = ''; state.blockCount = 0; addBlockInput();
                        }
                        ui.totalStudentsOriginal.textContent = 'N/A (Blank Sheet)';
                        showStatus(ui.fileStatus, 'Ready to create blank attendance sheets.', 'success');
                    } else {
                        const rangeContainer = document.getElementById('show-range-block-container');
                        if(rangeContainer) rangeContainer.classList.remove('hidden');
                        
                        state.studentsToAllocateCount = state.studentData.filter(s => !s.isAllocated).length;
                        ui.totalStudentsOriginal.textContent = state.totalStudentsInFile;
                        if (state.allocatedBlocks.length === 0 && ui.blocksContainer.children.length === 0) {
                             ui.blocksContainer.innerHTML = ''; state.blockCount = 0;
                        }
                    }
                    window.updateStudentCountStatus(); 
                }
            }

            function setTabMode(isBlank) {
                state.isBlankSheet = isBlank;
                state.studentData = [];
                state.totalStudentsInFile = 0;
                state.allocatedBlocks = [];
                ui.blocksContainer.innerHTML = '';
                
                ui.fileUploadContent.classList.toggle('hidden', isBlank);
                ui.blankSheetContent.classList.toggle('hidden', !isBlank);
                ui.nextToStep2BlankBtn.classList.toggle('hidden', !isBlank);
                ui.modeFileBtn.classList.toggle('active', !isBlank);
                ui.modeBlankBtn.classList.toggle('active', isBlank);
                ui.dataCleaningSection.classList.add('hidden');
                
                lucide.createIcons();
            }

            // --- Logic for Data Parsing ---
            function parseAoA(rawAoA, skipRows, isHeaderForced) {
                if (!rawAoA || rawAoA.length === 0) return { data: [], headers: [] };
                let dataRows = rawAoA.slice(skipRows);

                let firstMeaningfulRowIndex = -1;
                for(let i = 0; i < dataRows.length; i++) {
                    if (dataRows[i].some(cell => cell !== null && cell !== undefined && String(cell).trim() !== '')) {
                        firstMeaningfulRowIndex = i; break;
                    }
                }
                if (firstMeaningfulRowIndex === -1) return { data: [], headers: [] };
                
                dataRows = dataRows.slice(firstMeaningfulRowIndex);
                if (dataRows.length === 0) return { data: [], headers: [] };
                
                let headerRow = [];
                let studentDataAoA = [];
                
                if (isHeaderForced) {
                    headerRow = dataRows[0];
                    studentDataAoA = dataRows.slice(1);
                } else {
                    const columnsCount = dataRows[0].length;
                    headerRow = Array.from({ length: columnsCount }, (_, i) => `Column ${String.fromCharCode(65 + i)}`);
                    studentDataAoA = dataRows;
                }

                const sanitizedHeaders = {};
                const headers = headerRow.map((h, i) => {
                     let header = String(h || '').trim();
                     if(header === '') header = `Column ${String.fromCharCode(65 + i)}`;
                     let uniqueHeader = header;
                     let count = 1;
                     while(sanitizedHeaders[uniqueHeader]) { uniqueHeader = `${header}_${count++}`; }
                     sanitizedHeaders[uniqueHeader] = true;
                     return uniqueHeader;
                });
                
                const jsonData = studentDataAoA.map(row => {
                    const obj = {};
                    headers.forEach((h, i) => { obj[h] = row[i]; });
                    return obj;
                }).filter(row => Object.values(row).some(v => v !== undefined && v !== null && String(v).trim() !== ''));

                return { data: jsonData, headers: headers };
            }

            // --- Data Health Dashboard Logic ---
            function updateHealthDashboard(currentJsonData, headers) {
                if (!currentJsonData || !headers) return;

                // 1. Basic Metrics
                if(ui.metricRows) ui.metricRows.textContent = currentJsonData.length;
                if(ui.metricCols) ui.metricCols.textContent = headers.length;

                // 2. Check Duplicates if Enr Column Mapped
                const enrKey = ui.enrollmentMap.value;
                state.currentDuplicates = [];
                
                if (enrKey && headers.includes(enrKey)) {
                    const seen = new Set();
                    const duplicates = new Set();
                    currentJsonData.forEach(row => {
                        const val = row[enrKey];
                        if (val) {
                            if(seen.has(val)) duplicates.add(val);
                            seen.add(val);
                        }
                    });
                    state.currentDuplicates = Array.from(duplicates);
                }

                // 3. Update System Status
                const dupCount = state.currentDuplicates.length;
                const isReady = headers.length > 0 && ui.enrollmentMap.value && ui.nameMap.value && currentJsonData.length > 0;
                
                if (dupCount > 0) {
                    ui.statusText.textContent = "Issues Found";
                    // Clear previous icon and add new one
                    ui.statusIconWrapper.innerHTML = `<i data-lucide="alert-triangle" class="w-8 h-8 text-amber-500"></i>`;
                    ui.statusBar.className = "absolute right-0 top-0 bottom-0 w-1.5 bg-amber-500";
                    ui.duplicateCard.classList.remove('hidden');
                    ui.duplicateCount.textContent = dupCount;
                } else if (isReady) {
                    ui.statusText.textContent = "Ready to Proceed";
                    // Clear previous icon and add new one
                    ui.statusIconWrapper.innerHTML = `<i data-lucide="check-circle-2" class="w-8 h-8 text-green-500"></i>`;
                    ui.statusBar.className = "absolute right-0 top-0 bottom-0 w-1.5 bg-green-500";
                    ui.duplicateCard.classList.add('hidden'); // Force hide duplicate card
                    
                    // Show Next button if ready
                    ui.nextToStep2Btn.classList.remove('hidden');
                    ui.nextToStep2Btn.disabled = false;
                } else {
                    ui.statusText.textContent = "Waiting for Map";
                    
                    // Empty icon wrapper for waiting state
                    ui.statusIconWrapper.innerHTML = '';
                    
                    ui.statusBar.className = "absolute right-0 top-0 bottom-0 w-1.5 bg-slate-300";
                    ui.duplicateCard.classList.add('hidden');
                    ui.nextToStep2Btn.classList.add('hidden');
                }
                lucide.createIcons();
            }

            function viewDuplicates() {
                const list = document.getElementById('duplicates-list');
                list.innerHTML = '';
                state.currentDuplicates.forEach(d => {
                    const li = document.createElement('li');
                    li.textContent = d;
                    list.appendChild(li);
                });
                document.getElementById('duplicates-modal').classList.remove('hidden');
                document.getElementById('duplicates-modal').classList.add('flex');
            }
            
            function deduplicateAndRevalidate() {
                const enrKey = ui.enrollmentMap.value;
                if (!enrKey) return;
                alert(`Removing ${state.currentDuplicates.length} duplicates. Keeping first occurrence.`);
                finalizeDataCleaningAndMapping(true); // Pass flag to dedup
            }

            function liveUpdatePreview() {
                const skipRows = parseInt(ui.skipRowsInput.value) || 0;
                const isHeaderForced = ui.forceHeaderToggle.checked;
                
                const { data: currentJsonData, headers: currentHeaders } = parseAoA(state.rawAoA, skipRows, isHeaderForced);

                // Maintain selection if possible
                const prevEnr = ui.enrollmentMap.value;
                const prevName = ui.nameMap.value;

                ui.enrollmentMap.innerHTML = '';
                ui.nameMap.innerHTML = '';
                currentHeaders.forEach(header => {
                    const option = new Option(header, header);
                    ui.enrollmentMap.add(option.cloneNode(true));
                    ui.nameMap.add(option.cloneNode(true));
                });
                
                // Auto-detect logic
                if (prevEnr && currentHeaders.includes(prevEnr)) {
                    ui.enrollmentMap.value = prevEnr;
                } else {
                    // Try auto-detect
                    const autoEnrollment = window.findHeader(currentHeaders, ['enrollment no', 'enrollment', 'roll no', 'roll', 'enr no', 'column a']);
                    if(autoEnrollment) ui.enrollmentMap.value = autoEnrollment;
                }

                if (prevName && currentHeaders.includes(prevName)) {
                    ui.nameMap.value = prevName;
                } else {
                    // Try auto-detect
                    const autoName = window.findHeader(currentHeaders, ['student name', 'name of student', 'name', 'full name', 'column b']);
                    if(autoName) ui.nameMap.value = autoName;
                }

                const thead = ui.livePreviewTable.querySelector('thead');
                const tbody = ui.livePreviewTable.querySelector('tbody');
                thead.innerHTML = '';
                tbody.innerHTML = '';
                const headerRowHtml = currentHeaders.map(h => `<th class="px-4 py-3 text-left font-bold whitespace-nowrap bg-slate-100 border-b border-slate-200">${h}</th>`).join('');
                thead.innerHTML = `<tr>${headerRowHtml}</tr>`;

                currentJsonData.slice(0, 15).forEach((row, rowIndex) => {
                    const tr = document.createElement('tr');
                    tr.className = rowIndex % 2 === 0 ? 'bg-white hover:bg-slate-50' : 'bg-slate-50 hover:bg-slate-100';
                    const rowHtml = currentHeaders.map(h => `<td class="px-4 py-2 text-slate-600 whitespace-nowrap border-b border-slate-50 font-mono text-xs">${row[h] || ''}</td>`).join('');
                    tr.innerHTML = rowHtml;
                    tbody.appendChild(tr);
                });
                
                if (isHeaderForced) {
                    ui.previewInterpretation.textContent = "HEADER ROW: 1";
                    ui.previewInterpretation.className = "text-[10px] font-bold px-2 py-1 rounded bg-green-100 text-green-700";
                } else {
                    ui.previewInterpretation.textContent = "AUTO-GENERATED HEADERS";
                    ui.previewInterpretation.className = "text-[10px] font-bold px-2 py-1 rounded bg-amber-100 text-amber-700";
                }

                updateHealthDashboard(currentJsonData, currentHeaders);
                
                // NEW: Auto-finalize if valid columns are detected
                if(ui.enrollmentMap.value && ui.nameMap.value && currentJsonData.length > 0) {
                    // IMPORTANT: Pass false to avoid dedupe on simple view update, BUT update state.tempJsonData
                    finalizeDataCleaningAndMapping(false);
                }
            }
            
            // --- File & Paste Handlers ---
            function handlePasteData() {
                const text = ui.pasteArea.value.trim();
                if (!text) { alert("Please paste some data first."); return; }
                
                try {
                    // Use XLSX to parse strings (CSV/TSV detection)
                    const workbook = XLSX.read(text, { type: 'string' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const aoa = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    
                    if (aoa.length === 0) { alert("Could not parse data. Try checking the format."); return; }
                    
                    processRawData(aoa);
                } catch (e) {
                    alert("Error parsing pasted text: " + e.message);
                }
            }

            function handleFile(event) {
                if (state.isBlankSheet) return;
                const file = event.target.files[0];
                if (!file) { ui.fileNameSpan.textContent = 'No file selected'; return; }
                ui.fileNameSpan.textContent = file.name;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const aoa = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        
                        if (aoa.length === 0) { showStatus(ui.fileStatus, 'The file is empty.', 'error'); return; }
                        processRawData(aoa);

                    } catch (error) {
                        showStatus(ui.fileStatus, `Error reading file: ${error.message}.`, 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            }
            
            function processRawData(aoa) {
                state.rawAoA = aoa;
                state.inferredHeaderStatus = inferHeaderStatus(aoa);
                ui.forceHeaderToggle.checked = state.inferredHeaderStatus;
                ui.skipRowsInput.value = '0';
                
                ui.fileUploadContent.classList.add('hidden');
                ui.dataCleaningSection.classList.remove('hidden');
                window.liveUpdatePreview(); // Auto-calls detection
            }

            function finalizeDataCleaningAndMapping(autoDedupe = false) {
                const skipRows = parseInt(ui.skipRowsInput.value) || 0;
                const isHeaderForced = ui.forceHeaderToggle.checked;
                const { data: finalJsonData, headers: finalHeaders } = parseAoA(state.rawAoA, skipRows, isHeaderForced);

                if (finalJsonData.length === 0) { return; } // No alert on auto-check

                state.enrollmentNoKey = ui.enrollmentMap.value;
                state.studentNameKey = ui.nameMap.value;

                if (!state.enrollmentNoKey || !state.studentNameKey) { return; } // Wait for valid selection

                let cleanData = finalJsonData;
                if (autoDedupe === true) {
                     const seen = new Set();
                     cleanData = [];
                     finalJsonData.forEach(item => {
                         const val = item[state.enrollmentNoKey];
                         if (!seen.has(val)) {
                             seen.add(val);
                             cleanData.push(item);
                         }
                     });
                     
                     // CRITICAL FIX: Update dashboard immediately with CLEAN data to reflect new counts/status
                     // This ensures user sees "Total Students" drop and "Ready" status instantly
                     updateHealthDashboard(cleanData, finalHeaders);
                } 

                state.tempJsonData = cleanData;
                state.rawHeaders = finalHeaders;
                state.studentData = state.tempJsonData.map(row => ({ ...row, isAllocated: false }));
                state.totalStudentsInFile = state.studentData.length;
                
                // Enable Next button but DON'T navigate automatically
                ui.nextToStep2Btn.classList.remove('hidden');
                ui.nextToStep2Btn.disabled = false;
            }
            
            // --- Header Utils ---
            function inferHeaderStatus(aoa) {
                if (aoa.length < 2) return false;
                const firstRow = aoa[0]; const secondRow = aoa[1];
                let textScoreFirst = 0; let textScoreSecond = 0;
                const keywords = ['no', 'name', 'code', 'date', 'roll', 'enrollment', 'student', 'subject'];
                firstRow.forEach((cell) => {
                    const val = String(cell || '').toLowerCase().trim();
                    if (isNaN(val) && val !== '') textScoreFirst++;
                    if (keywords.some(k => val.includes(k))) textScoreFirst += 2;
                });
                 secondRow.forEach((cell) => {
                    const val = String(cell || '').toLowerCase().trim();
                    if (isNaN(val) && val !== '') textScoreSecond++;
                });
                return (textScoreFirst > textScoreSecond + 2) && (textScoreFirst > (firstRow.length * 0.5));
            }
            
            function findHeader(headers, possibleNames) {
                 for (const name of possibleNames) {
                    const found = headers.find(h => String(h).toLowerCase().trim().includes(name));
                    if (found) return found;
                }
                return null;
            }

            // --- Step 2 & 3 Helpers (Shortened for brevity as logic unchanged) ---
            function createSpecialBlock() {
                const start = ui.rangeBlock.startEnrollment.value.trim().toUpperCase();
                const end = ui.rangeBlock.endEnrollment.value.trim().toUpperCase();
                if (!start || !end) { alert('Enter start and end enrollment.'); return; }

                const studentsInRange = state.studentData.filter(student => {
                    const enrNo = String(student[state.enrollmentNoKey]).toUpperCase();
                    return !student.isAllocated && enrNo >= start && enrNo <= end;
                });

                if (studentsInRange.length === 0) { alert('No unallocated students found in range.'); return; }
                state.studentData.forEach(s => s.isAllocated = false);
                studentsInRange.forEach(s => s.isAllocated = true);
                
                ui.blocksContainer.innerHTML = ''; state.allocatedBlocks = [];
                addBlockInput(true, { center: ui.rangeBlock.center.value, roomNo: ui.rangeBlock.roomNo.value, blockNo: ui.rangeBlock.blockNo.value, count: studentsInRange.length });
                saveBlockState(); navigateToStep(3);
            }

            function addBlockInput(isSpecial = false, details = {}) {
                state.blockCount++;
                const blockDiv = document.createElement('div');
                blockDiv.className = 'block-item flex flex-col gap-4 mb-4 p-4 rounded-lg bg-slate-50 border border-slate-200';
                const defaultDetails = { center: 'SOCSET', roomNo: state.isBlankSheet ? `R-BLANK-${state.blockCount}` : '', blockNo: state.isBlankSheet ? `B-BLANK-${state.blockCount}` : '', count: state.isBlankSheet ? 30 : 0 };
                const f = { ...defaultDetails, ...details };
                
                let inner = `<div class="flex items-center justify-between"><div class="font-bold text-lg text-slate-700">${isSpecial ? 'Special Block' : `Block ${state.blockCount}`}</div>${!isSpecial ? `<button class="remove-block-btn" onclick="this.closest('.block-item').remove(); updateStudentCountStatus();">&times;</button>` : ''}</div><div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
                const attr = isSpecial ? 'readonly class="bg-slate-100"' : 'required';
                const cls = isSpecial ? 'bg-slate-100' : '';
                
                if(isSpecial) {
                     inner += `<div class="input-group"><label class="text-sm text-slate-700">Exam Centre</label><input type="text" class="block-center ${cls}" value="${f.center}" readonly></div>`;
                } else {
                     inner += `<div class="input-group"><label class="text-sm text-slate-700">Exam Centre</label><select class="block-center" required><option value="SOB">SOB</option><option value="SOP">SOP</option><option value="SOCSET" ${f.center === 'SOCSET' ? 'selected' : ''}>SOCSET</option></select></div>`;
                }
                inner += `<div class="input-group"><label class="text-sm text-slate-700">Room No.</label><input type="text" class="block-room-no ${cls}" value="${f.roomNo}" ${attr}></div>`;
                inner += `<div class="input-group"><label class="text-sm text-slate-700">Block No.</label><input type="text" class="block-no ${cls}" value="${f.blockNo}" ${attr}></div>`;
                inner += `<div class="input-group"><label class="text-sm text-slate-700">Students</label><input type="number" class="block-students ${cls}" value="${f.count}" ${attr} min="1"></div></div>`;
                
                blockDiv.innerHTML = inner;
                ui.blocksContainer.appendChild(blockDiv);
                if(!isSpecial) {
                     applyAutoCapitalization(blockDiv.querySelector('.block-room-no'));
                     applyAutoCapitalization(blockDiv.querySelector('.block-no'));
                }
                window.updateStudentCountStatus();
            }

            function updateStudentCountStatus() {
                if (state.isBlankSheet) {
                    const inputs = Array.from(ui.blocksContainer.querySelectorAll('.block-students:not([readonly])'));
                    state.studentsToAllocateCount = inputs.reduce((sum, input) => sum + (parseInt(input.value) || 0), 0);
                    ui.totalStudentsOriginal.textContent = `N/A`; ui.totalStudentsToAllocate.textContent = state.studentsToAllocateCount;
                    ui.nextToStep3Btn.disabled = state.studentsToAllocateCount <= 0;
                    return;
                }
                state.studentsToAllocateCount = state.studentData.filter(s => !s.isAllocated).length;
                ui.totalStudentsToAllocate.textContent = state.studentsToAllocateCount;
                const inputs = Array.from(ui.blocksContainer.querySelectorAll('.block-students:not([readonly])'));
                const totalInRegular = inputs.reduce((sum, input) => sum + (parseInt(input.value) || 0), 0);
                
                ui.studentCountStatus.classList.remove('hidden', 'status-success', 'status-warn', 'status-error');
                ui.nextToStep3Btn.disabled = true;

                if (totalInRegular > state.studentsToAllocateCount) {
                    showStatus(ui.studentCountStatus, `Allocated: ${totalInRegular} (Exceeds remaining by ${totalInRegular - state.studentsToAllocateCount})`, 'error');
                } else if (totalInRegular === state.studentsToAllocateCount) {
                    showStatus(ui.studentCountStatus, `Allocated: ${totalInRegular} (Perfect!)`, 'success');
                    if (totalInRegular > 0 || ui.blocksContainer.querySelector('[readonly]')) ui.nextToStep3Btn.disabled = false;
                } else {
                    showStatus(ui.studentCountStatus, `Allocated: ${totalInRegular} (Remaining: ${state.studentsToAllocateCount - totalInRegular})`, 'warn');
                }
            }
            
            function getBlockDetails(blockElement, count, general) {
                 return { ...general, center: blockElement.querySelector('.block-center')?.value.toUpperCase() || 'N/A', roomNo: blockElement.querySelector('.block-room-no')?.value.toUpperCase() || 'N/A', blockNo: blockElement.querySelector('.block-no')?.value.toUpperCase() || 'N/A', totalStudentsInBlock: count };
            }

            // Modified generatePDF helper to create array for SINGLE download (called by row button)
            // But we use a new function "generatePDF" effectively by calling logic directly
            // Re-using logic:
            async function generatePDF(examList, isCombined) {
                 ui.loadingOverlay.classList.remove('hidden');
                 ui.loadingOverlay.classList.add('flex');
                 
                 try {
                     const doc = new jsPDF('p', 'mm', 'a4');
                     let isFirstPage = true;
                     
                     for (const exam of examList) {
                        const examDetails = {
                            ...exam.global,
                            ...exam.schedule,
                            isRemedial: exam.global.isRemedial,
                            includeSubjectColumn: exam.global.includeSubjectColumn
                        };
                        const blockData = getBlockDataForExam(examDetails);
                         for (let i = 0; i < blockData.length; i++) {
                            if (!isFirstPage) doc.addPage();
                            await drawPageOnDoc(doc, blockData[i].students, blockData[i].details, i + 1, blockData.length);
                            isFirstPage = false;
                        }
                     }
                     
                     // File Naming Logic: Diploma - 2 remedial 23 nov 2025
                     let fileName = 'Combined_Exam_Schedule.pdf';
                     if (examList.length === 1) {
                         const e = examList[0];
                         // Clean Branch Name
                         const branch = e.global.branch || 'Exam';
                         const sem = e.global.semester ? e.global.semester.replace('Semester - ', '') : '';
                         const spec = e.global.specialization !== 'N/A' ? e.global.specialization : '';
                         const type = e.global.isRemedial ? 'Remedial' : 'Regular';
                         const date = e.schedule.examDate || 'Date'; // e.g. 23-Nov-2025 (from flatpickr altFormat usually, but stored is typically YYYY-MM-DD or flatpickr formatted)
                         // Flatpickr is configured as dateFormat: "d-m-Y" -> 23-11-2025
                         // Let's try to format date nicely if possible or just use as is
                         
                         fileName = `${branch} - ${sem} ${spec} ${type} ${date}.pdf`;
                     } else {
                         // Combined: Use first exam's branch/sem/type/date or generic if mixed?
                         // Requirement: "Diploma 2 remedial combined (branch sem exam type date)"
                         // Assuming all exams in queue share global settings except subject/time?
                         // Usually user sets global settings once.
                         const first = examList[0];
                         const branch = first.global.branch || 'Exam';
                         const sem = first.global.semester ? first.global.semester.replace('Semester - ', '') : '';
                         const spec = first.global.specialization !== 'N/A' ? first.global.specialization : '';
                         const type = first.global.isRemedial ? 'Remedial' : 'Regular';
                         const date = first.schedule.examDate || ''; 
                         
                         fileName = `${branch} - ${sem} ${spec} ${type} Combined ${date}.pdf`;
                     }
                     
                     doc.save(fileName);
                     
                 } catch(e) {
                     console.error(e);
                     alert("Error generating PDF");
                 } finally {
                     ui.loadingOverlay.classList.add('hidden');
                     ui.loadingOverlay.classList.remove('flex');
                 }
            }

            async function generateCombinedQueuePDF() {
                if(state.examQueue.length === 0) return;
                generatePDF(state.examQueue, true);
            }

            function getBlockDataForExam(generalDetails) {
                const allBlockStudents = [];
                const specialBlock = state.allocatedBlocks.find(b => b.isSpecial);
                const specialIndices = new Set();
                
                if(specialBlock && !state.isBlankSheet) {
                    state.studentData.forEach((s, idx) => {
                        if (specialBlock.studentEnrollments.includes(s[state.enrollmentNoKey])) specialIndices.add(idx);
                    });
                }
                
                let regularIndices = [];
                if(!state.isBlankSheet) state.studentData.forEach((s, idx) => { if(!specialIndices.has(idx)) regularIndices.push(idx); });
                
                let regularCursor = 0;
                state.allocatedBlocks.forEach(savedBlock => {
                    let studentsForBlock = [];
                    if (state.isBlankSheet) {
                        studentsForBlock = Array(savedBlock.count).fill(null).map(() => ({ [state.enrollmentNoKey]: '', [state.studentNameKey]: '' }));
                    } else if (savedBlock.isSpecial) {
                        studentsForBlock = state.studentData.filter((s, i) => specialIndices.has(i));
                    } else {
                        studentsForBlock = regularIndices.slice(regularCursor, regularCursor + savedBlock.count).map(i => state.studentData[i]);
                        regularCursor += savedBlock.count;
                    }
                    allBlockStudents.push({ students: studentsForBlock, details: { ...generalDetails, ...savedBlock, totalStudentsInBlock: savedBlock.count } });
                });
                return allBlockStudents;
            }

            async function drawPageOnDoc(doc, students, examDetails, currentPage, totalPages) {
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                
                // 1. Header Section
                let headerStartY = 10;
                let headerEndY = headerStartY + 10; 
            
                if (state.logoBase64) {
                    doc.addImage(state.logoBase64, 'PNG', 10, headerStartY, 40, (40/2.0)); 
                    headerEndY = headerStartY + (40/3.5); 
                } else {
                    doc.setFont("helvetica", "bold").setFontSize(10).text("ITM SLS BARODA UNIVERSITY", 15, headerStartY + 5);
                }
                
                doc.setFont("helvetica", "normal").setFontSize(9);
                doc.text("Attendance Sheet", pageWidth - 15, headerStartY + 5, { align: "right" });
                
                let line2 = `${examDetails.branch}`;
                if (examDetails.isRemedial) line2 += ' REMEDIAL';
                if (examDetails.specialization && examDetails.specialization !== 'N/A') line2 += ` ${examDetails.specialization}`;
                line2 += ` ${examDetails.semester} - ${examDetails.academicYear}`;
                doc.text(line2, pageWidth - 15, headerStartY + 10, { align: "right" });
                doc.text(`(Students: ${examDetails.totalStudentsInBlock})`, pageWidth - 15, headerStartY + 15, { align: "right" });
                
                headerEndY = Math.max(headerEndY, headerStartY + 20);
                doc.setDrawColor(0); doc.setLineWidth(0.2); 
                doc.line(15, headerEndY, pageWidth - 15, headerEndY); 
                
                const sEnr = students.length ? (students[0][state.enrollmentNoKey]||'') : '';
                const eEnr = students.length ? (students[students.length-1][state.enrollmentNoKey]||'') : '';
                const range = state.isBlankSheet ? "MANUAL ENTRY" : `FROM ${sEnr} TO ${eEnr}`;
            
                // 2. Exam Details Table
                doc.autoTable({
                    startY: headerEndY + 2, 
                    theme: 'grid',
                    styles: { fontSize: 8, cellPadding: 1, lineWidth: 0.3, lineColor: 0, valign: 'middle', textColor: 0 },
                    headStyles: { lineColor: 0 },
                    body: [
                        [{ content: `CENTRE: SOCSET` }, { content: `BLOCK NO: ${examDetails.blockNo}` }, { content: `DATE: ${examDetails.examDate} | TIME: ${examDetails.examTime}` }],
                        [{ content: `EXAM CENTRE: ${examDetails.center}` }, { content: `COURSE: ${examDetails.courseCode} - ${examDetails.courseName}`, colSpan: 2 }],
                        [{ content: `ROOM NO.: ${examDetails.roomNo}` }, { content: `ENROLLMENT NO: ${range}`, colSpan: 2 }]
                    ],
                    columnStyles: { 0: { cellWidth: 45 }, 1: { cellWidth: 45 }, 2: { cellWidth: 'auto' } },
                });
                
                const tableData = students.map((s, i) => {
                    const r = [ (i + 1), s[state.enrollmentNoKey] || '', s[state.studentNameKey] || '', '', '' ];
                    if(examDetails.includeSubjectColumn) r.splice(3, 0, '');
                    return r;
                });
            
                let head = [['S.No.', 'Enrollment No.', 'Name of Student', 'No. of Supplementary', 'SIGN']];
                let cols = { 0: { cellWidth: 10 }, 1: { cellWidth: 30 }, 2: { cellWidth: 70, halign: 'left' }, 3: { cellWidth: 30 }, 4: { cellWidth: 'auto' } };
                if(examDetails.includeSubjectColumn) {
                    head = [['S.No.', 'Enrollment No.', 'Name of Student', 'Subject Name', 'No. of Supplementary', 'SIGN']];
                    cols = { 0: { cellWidth: 10 }, 1: { cellWidth: 25 }, 2: { cellWidth: 55, halign: 'left' }, 3: { cellWidth: 35, halign: 'left' }, 4: { cellWidth: 25 }, 5: { cellWidth: 'auto' } };
                }
            
                // 3. Student List - CONTENT SIZE 8
                doc.autoTable({
                    startY: doc.autoTable.previous.finalY + 2, 
                    head: head, 
                    body: tableData, 
                    theme: 'grid',
                    styles: { fontSize: 8, cellPadding: 1.2, halign: 'center', textColor: 0, lineColor: 0, lineWidth: 0.3 }, 
                    headStyles: { fillColor: 255, textColor: 0, fontStyle: 'bold', lineColor: 0, lineWidth: 0.3 },
                    columnStyles: cols
                });
            
                let finalY = doc.autoTable.previous.finalY;
            
                // 4. Page Break Check - 35mm
                if (pageHeight - finalY < 35) { 
                    doc.addPage(); 
                    finalY = 15; 
                }
            
                // 5. Summary Table
                doc.autoTable({
                    startY: finalY + 4,
                    head: [["Total Students", "Present Students", "Absent Students", "Answerbook Used", "Supplementary Used", "Malpractice Reported"]],
                    body: [["", "", "", "", "", ""]], 
                    theme: 'grid',
                    styles: { fontSize: 8, halign: 'center', cellPadding: 2, textColor: 0, lineColor: 0, lineWidth: 0.3 },
                    headStyles: { fillColor: 255, textColor: 0, fontStyle: 'bold', lineColor: 0, lineWidth: 0.3 }
                });
            
                // FIX: "Total Students" number alignment adjusted to match pic
                doc.setFont("helvetica", "bold").setFontSize(8);
                const firstCellWidth = (pageWidth - 30) / 6; 
                const cellCenterX = 15 + (firstCellWidth / 2);
                // Adjusted vertical offset (+0.5) to fix the "lil off" centering
                doc.text(String(examDetails.totalStudentsInBlock), cellCenterX, doc.autoTable.previous.finalY - 2.2, { align: 'center' });
            
                finalY = doc.autoTable.previous.finalY;
                
                // 6. Declaration - FIX: CENTER ALIGN
                doc.setFont("helvetica", "normal").setFontSize(8);
                const declarationText = "I hereby declare that I have verified above mentioned details and also declare that students have returned these answer books as mentioned above.";
                doc.text(declarationText, pageWidth / 2, finalY + 6, { align: 'center', maxWidth: pageWidth - 30 });
                
                // 7. Signature Footer - FIX: BLACK COLOR AF
                const lineY = finalY + 22; 
                const textY = lineY + 5;  
                const lineWidth = 58; 
            
                // Pure Black for lines
                doc.setDrawColor(0, 0, 0); 
                doc.setLineWidth(0.4); // Slightly thicker for "BLACK AF" look
                
                // Signature of Invigilator
                doc.line(15, lineY, 15 + lineWidth, lineY);
                doc.text("Signature of Invigilator", 15 + lineWidth / 2, textY, { align: "center" });
                
                // Signature of Deputy Chief Superintendent
                const centerStart = (pageWidth / 2) - (lineWidth / 2);
                doc.line(centerStart, lineY, centerStart + lineWidth, lineY);
                doc.text("Signature of Deputy Chief Superintendent", pageWidth / 2, textY, { align: "center" });
                
                // Signature of Chief Superintendent
                doc.line(pageWidth - 15 - lineWidth, lineY, pageWidth - 15, lineY);
                doc.text("Signature of Chief Superintendent", pageWidth - 15 - lineWidth / 2, textY, { align: "center" });
            }

            function showStatus(element, message, type) {
                const cls = { 'success': 'status-success', 'warn': 'status-warn', 'error': 'status-error' };
                element.className = `status-box ${cls[type]}`;
                element.textContent = message;
                element.classList.remove('hidden');
                lucide.createIcons();
            }
            
            // Init
            function populateAcademicYears() {
                const yearSelect = ui.examDetails.academicYear; yearSelect.innerHTML = '<option value="">Select Academic Year</option>';
                const y = new Date().getFullYear();
                for (let i = -1; i < 4; i++) { 
                    const opt = document.createElement('option');
                    opt.value = `${y+i}-${(y+i+1).toString().slice(-2)}`; opt.textContent = opt.value;
                    if(i === 0) opt.selected = true; yearSelect.appendChild(opt);
                }
            }
            
            async function preloadLogo() {
                try {
                    const r = await fetch('itmbu_logo.png'); if(!r.ok) throw new Error();
                    const b = await r.blob(); const reader = new FileReader();
                    reader.readAsDataURL(b); reader.onloadend = () => { state.logoBase64 = reader.result; };
                } catch (e) { console.warn('No local logo'); }
            }

            populateAcademicYears();
            flatpickr("#exam-date", { altInput: true, altFormat: "F j, Y", dateFormat: "d-m-Y", defaultDate: "today" });
            flatpickr("#exam-time", { enableTime: true, noCalendar: true, dateFormat: "h:i K", defaultDate: new Date() });
            preloadLogo();
            loadFromLocalStorage();
            setupEventListeners(); 
            setTabMode(false);
            navigateToStep(1);
        });
    </script>
</body>
</html>



